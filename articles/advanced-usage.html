<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced usage • SparseNUTS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Advanced usage">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SparseNUTS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/SparseNUTS.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/advanced-usage.html">Advanced usage</a></li>
    <li><a class="dropdown-item" href="../articles/Implementing-bounds.html">Implementing parameter transformations in SNUTS</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/noaa-afsc/SparseNUTS/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Advanced usage</h1>
                        <h4 data-toc-skip class="author">Cole C.
Monnahan</h4>
            
            <h4 data-toc-skip class="date">2026-02-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/noaa-afsc/SparseNUTS/blob/main/vignettes/advanced-usage.Rmd" class="external-link"><code>vignettes/advanced-usage.Rmd</code></a></small>
      <div class="d-none name"><code>advanced-usage.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://noaa-afsc.github.io/SparseNUTS">SparseNUTS</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="a-more-complicated-example">A more complicated example<a class="anchor" aria-label="anchor" href="#a-more-complicated-example"></a>
</h2>
<p>To demonstrate more than the basic usage I will use a more
complicated model. I modified the ChickWeight random slopes and
intercepts example from the RTMB introduction. Modifications include:
switching SD parameters to log space and adding a Jacobian, adding broad
priors for these SDs, and adding a ‘loglik’ vector for PSIS-LOO
(below).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kaskr/RTMB" class="external-link">RTMB</a></span><span class="op">)</span> </span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mua<span class="op">=</span><span class="fl">0</span>,          <span class="co">## Mean slope</span></span>
<span>  logsda<span class="op">=</span><span class="fl">0</span>,          <span class="co">## Std of slopes</span></span>
<span>  mub<span class="op">=</span><span class="fl">0</span>,          <span class="co">## Mean intercept</span></span>
<span>  logsdb<span class="op">=</span><span class="fl">0</span>,          <span class="co">## Std of intercepts</span></span>
<span>  logsdeps<span class="op">=</span><span class="fl">1</span>,        <span class="co">## Residual Std</span></span>
<span>  a<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>,   <span class="co">## Random slope by chick</span></span>
<span>  b<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>    <span class="co">## Random intercept by chick</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">parms</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kaskr/RTMB" class="external-link">RTMB</a></span><span class="op">)</span> <span class="co"># for tmbstan</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">ChickWeight</span>, <span class="va">parms</span>, warn<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">sda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logsda</span><span class="op">)</span></span>
<span>  <span class="va">sdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logsdb</span><span class="op">)</span></span>
<span>  <span class="va">sdeps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logsdeps</span><span class="op">)</span></span>
<span>  <span class="co">## Optional (enables extra RTMB features)</span></span>
<span>  <span class="va">weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">OBS</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span></span>
<span>  <span class="va">predWeight</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">[</span><span class="va">Chick</span><span class="op">]</span> <span class="op">*</span> <span class="va">Time</span> <span class="op">+</span> <span class="va">b</span><span class="op">[</span><span class="va">Chick</span><span class="op">]</span></span>
<span>  <span class="va">loglik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">weight</span>, <span class="va">predWeight</span>, sd<span class="op">=</span><span class="va">sdeps</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate the target density</span></span>
<span>  <span class="va">lp</span> <span class="op">&lt;-</span>   <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">loglik</span><span class="op">)</span><span class="op">+</span> <span class="co"># likelihood</span></span>
<span>    <span class="co"># random effect vectors</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">a</span>, mean<span class="op">=</span><span class="va">mua</span>, sd<span class="op">=</span><span class="va">sda</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">b</span>, mean<span class="op">=</span><span class="va">mub</span>, sd<span class="op">=</span><span class="va">sdb</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># broad half-normal priors on SD pars</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">sda</span>, <span class="fl">0</span>, <span class="fl">10</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">sdb</span>, <span class="fl">0</span>, <span class="fl">10</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">sdeps</span>, <span class="fl">0</span>, <span class="fl">10</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co"># jacobian adjustments</span></span>
<span>    <span class="va">logsda</span> <span class="op">+</span> <span class="va">logsdb</span> <span class="op">+</span> <span class="va">logsdeps</span></span>
<span>  </span>
<span>  <span class="co"># reporting</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">loglik</span><span class="op">)</span>       <span class="co"># for PSIS-LOO</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">ADREPORT</a></span><span class="op">(</span><span class="va">predWeight</span><span class="op">)</span> <span class="co"># delta method</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">predWeight</span><span class="op">)</span>   <span class="co"># standard report</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">lp</span><span class="op">)</span> <span class="co"># negative log-posterior density</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">f</span>, <span class="va">parameters</span>, random<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="asymptotic-frequentist-approximatation-vs-full-posterior">Asymptotic (frequentist) approximatation vs full posterior<a class="anchor" aria-label="anchor" href="#asymptotic-frequentist-approximatation-vs-full-posterior"></a>
</h2>
<p>Instead of sampling from the posterior with MCMC (SNUTS), I can use
asymptotic tools from TMB to get a quick approximation of the
parameters, their covariances, but also uncertainties of generated
quantities via the generalized delta method. See the TMB documentation
for more background. Briefly, the marginal posterior mode is found and a
joint precision matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
determined at the conditional mode.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Σ</mi><mo>=</mo><mi>Q</mi><mrow><mo>−</mo><mn>1</mn></mrow></mrow><annotation encoding="application/x-tex">\Sigma=Q{-1}</annotation></semantics></math>
is the covariance of the parameters.</p>
<p>First I optimize the model and call TMB’s <code>sdreport</code>
function to get approximate uncertainties via the delta method and the
joint precision matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># optimize</span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">obj</span>, <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">fn</span>, <span class="va">gr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># get generalized delta method results and Q</span></span>
<span><span class="va">sdrep</span> <span class="op">&lt;-</span> <span class="fu">sdreport</span><span class="op">(</span><span class="va">obj</span>, getJointPrecision<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the generalized delta method estimates of asymptotic</span></span>
<span><span class="co"># standard errors</span></span>
<span><span class="va">est</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdrep</span>, <span class="st">'Estimate'</span>, report<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">predWeight</span></span>
<span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">sdrep</span>, <span class="st">'Std. Error'</span>, report<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">predWeight</span></span>
<span></span>
<span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="va">sdrep</span><span class="op">$</span><span class="va">jointPrecision</span></span>
<span><span class="co"># can get the joint covariance and correlation like this</span></span>
<span><span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">Q</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_Q.html">plot_Q</a></span><span class="op">(</span>Q<span class="op">=</span><span class="va">Q</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/unnamed-chunk-2-1.png" class="r-plt" alt="" width="700"></p>
<p>Now I run SNUTS on it and get posterior samples to compare to.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># some very strong negative correlations so I expect a dense or</span></span>
<span><span class="co"># sparse metric to be selected with SNUTS. Because I optimized</span></span>
<span><span class="co"># above can skip that</span></span>
<span><span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj</span>, chains<span class="op">=</span><span class="fl">1</span>, init<span class="op">=</span><span class="st">'random'</span>, seed<span class="op">=</span><span class="fl">1234</span>,</span>
<span>                     refresh<span class="op">=</span><span class="fl">0</span>, skip_optimization<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                     Q<span class="op">=</span><span class="va">Q</span>, Qinv<span class="op">=</span><span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="co">#&gt; Q is 92.58% zeroes, with condition factor=74028 (min=0.014, max=1018.9)</span></span>
<span><span class="co">#&gt; Rebuilding RTMB obj without random effects...</span></span>
<span><span class="co">#&gt; dense metric selected b/c faster than sparse and high correlation (max=0.81)</span></span>
<span><span class="co">#&gt; log-posterior at inits=(-2627.04); at conditional mode=-2574.481</span></span>
<span><span class="co">#&gt; Starting MCMC sampling...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Gradient evaluation took 0.000245 seconds</span></span>
<span><span class="co">#&gt; 1000 transitions using 10 leapfrog steps per transition would take 2.45 seconds.</span></span>
<span><span class="co">#&gt; Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Elapsed Time: 0.397 seconds (Warm-up)</span></span>
<span><span class="co">#&gt;                1.794 seconds (Sampling)</span></span>
<span><span class="co">#&gt;                2.191 seconds (Total)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 'RTMB' has 105 pars, and was fit using NUTS with a 'dense' metric</span></span>
<span><span class="co">#&gt; 1 chain(s) of 1150 total iterations (150 warmup) were used</span></span>
<span><span class="co">#&gt; Average run time per chain was 2.19 seconds </span></span>
<span><span class="co">#&gt; Minimum ESS=271.1 (27.11%), and maximum Rhat=1.019</span></span>
<span><span class="co">#&gt; There were 0 divergences after warmup</span></span>
<span><span class="va">post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_uncertainties.html">plot_uncertainties</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## get posterior of generated quantities</span></span>
<span><span class="va">predWeight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">post</span>,<span class="fl">1</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">obj</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">predWeight</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">predWeight</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:1000, 1:578] 28.1 29.3 23.5 24.8 26.7 ...</span></span>
<span></span>
<span><span class="co"># compare asymptotic vs posterior intervals of first few chicks</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">predWeight</span><span class="op">[</span>,<span class="va">ii</span><span class="op">]</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, len<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span>  <span class="va">y2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">est</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span>, <span class="va">se</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">y</span>, freq<span class="op">=</span><span class="cn">FALSE</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">y2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y2</span>, col<span class="op">=</span><span class="fl">2</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/unnamed-chunk-3-2.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulation-of-parameters-and-data">Simulation of parameters and data<a class="anchor" aria-label="anchor" href="#simulation-of-parameters-and-data"></a>
</h2>
<p>Simulation of data can be done directly in R. Specialized simulation
functionality exists for TMB, and to a lesser degree RTMB, but I keep it
simple here for demonstration purposes.</p>
<p>Both data and parameters can be simulated and I explore that
below.</p>
<div class="section level3">
<h3 id="prior-and-posterior-predictive-distributions">Prior and posterior predictive distributions<a class="anchor" aria-label="anchor" href="#prior-and-posterior-predictive-distributions"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simulation of data sets can be done manually in R. For instance</span></span>
<span><span class="co"># to get posterior predictive I loop through each posterior</span></span>
<span><span class="co"># sample and draw new data.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">351231</span><span class="op">)</span></span>
<span><span class="va">simdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">post</span>,<span class="fl">1</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="va">yhat</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">predWeight</span></span>
<span>   <span class="va">ysim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">yhat</span><span class="op">)</span>, <span class="va">yhat</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="st">'logsdeps'</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">]</span>, main<span class="op">=</span><span class="st">'Posterior predictive'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">ChickWeight</span><span class="op">$</span><span class="va">weight</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">]</span>, col<span class="op">=</span><span class="fl">2</span>, cex<span class="op">=</span><span class="fl">2</span>, pch<span class="op">=</span><span class="fl">16</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/unnamed-chunk-4-1.png" class="r-plt" alt="" width="700"></p>
<p>Prior predictive sampling would be done in the same way but is not
shown here.</p>
</div>
<div class="section level3">
<h3 id="joint-precision-sampling">Joint precision sampling<a class="anchor" aria-label="anchor" href="#joint-precision-sampling"></a>
</h3>
<p>Samples can be drawn from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>,
assuming multivariate normality, as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># likewise I can simulate draws from Q to get approximate samples</span></span>
<span><span class="va">postQ</span> <span class="op">&lt;-</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="fl">1000</span>, mean<span class="op">=</span><span class="va">mcmc</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">est</span>, sigma<span class="op">=</span><span class="va">Sigma</span><span class="op">)</span></span></code></pre></div>
<p>These samples could be put back into the <code>report</code> function
to get a distribution of a generated quantity, for instance.</p>
</div>
</div>
<div class="section level2">
<h2 id="model-selection-with-psis-loo">Model selection with PSIS-LOO<a class="anchor" aria-label="anchor" href="#model-selection-with-psis-loo"></a>
</h2>
<p>PSIS-LOO is the recommended way to compare predictive performance of
Bayesian models. I use it to compare a simplified Chicks model below
using the <code>map</code> argument to turn off estimation of the random
intercepts (‘b’). All this requires is for the vector of log-likelihood
values to be available for each posterior draw. I facilitate this via a
<code>REPORT(loglik)</code> call above.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/loo/" class="external-link">loo</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is loo version 2.9.0</span></span>
<span><span class="co">#&gt; - Online documentation and vignettes at mc-stan.org/loo</span></span>
<span><span class="co">#&gt; - As of v2.0.0 loo defaults to 1 core but we recommend using as many as possible. Use the 'cores' argument or set options(mc.cores = NUM_CORES) for an entire session.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores<span class="op">=</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">loglik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">post</span>,<span class="fl">1</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">obj</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">loglik</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">loo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">loglik</span>, cores<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computed from 1000 by 578 log-likelihood matrix.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          Estimate   SE</span></span>
<span><span class="co">#&gt; elpd_loo  -2351.8 19.9</span></span>
<span><span class="co">#&gt; p_loo        88.5  6.9</span></span>
<span><span class="co">#&gt; looic      4703.6 39.7</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; MCSE of elpd_loo is NA.</span></span>
<span><span class="co">#&gt; MCSE and ESS estimates assume independent draws (r_eff=1).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pareto k diagnostic values:</span></span>
<span><span class="co">#&gt;                           Count Pct.    Min. ESS</span></span>
<span><span class="co">#&gt; (-Inf, 0.67]   (good)     572   99.0%   103     </span></span>
<span><span class="co">#&gt;    (0.67, 1]   (bad)        6    1.0%   &lt;NA&gt;    </span></span>
<span><span class="co">#&gt;     (1, Inf)   (very bad)   0    0.0%   &lt;NA&gt;    </span></span>
<span><span class="co">#&gt; See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">loo1</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># I can compare that to a simpler model which doesn't have</span></span>
<span><span class="co"># random effects on the slope</span></span>
<span><span class="va">obj2</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span><span class="va">f</span>, <span class="va">parameters</span>, random<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span>, silent<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                  map<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                           logsdb<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>                           mub<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mcmc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj2</span>, chains<span class="op">=</span><span class="fl">1</span>, seed<span class="op">=</span><span class="fl">1215</span>, refresh<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Optimizing...</span></span>
<span><span class="co">#&gt; Getting Q...</span></span>
<span><span class="co">#&gt; Inverting Q...</span></span>
<span><span class="co">#&gt; Q is 88.9% zeroes, with condition factor=8423 (min=0.128, max=1080.5)</span></span>
<span><span class="co">#&gt; Rebuilding RTMB obj without random effects...</span></span>
<span><span class="co">#&gt; diag metric selected b/c of low correlations (max=0.1386)</span></span>
<span><span class="co">#&gt; log-posterior at inits=(-2745.52); at conditional mode=-2745.519</span></span>
<span><span class="co">#&gt; Starting MCMC sampling...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Gradient evaluation took 0.000113 seconds</span></span>
<span><span class="co">#&gt; 1000 transitions using 10 leapfrog steps per transition would take 1.13 seconds.</span></span>
<span><span class="co">#&gt; Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Elapsed Time: 0.205 seconds (Warm-up)</span></span>
<span><span class="co">#&gt;                1.12 seconds (Sampling)</span></span>
<span><span class="co">#&gt;                1.325 seconds (Total)</span></span>
<span><span class="co">#&gt; Warning: The ESS has been capped to avoid unstable estimates.</span></span>
<span><span class="co">#&gt; Warning: The ESS has been capped to avoid unstable estimates.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 'RTMB' has 53 pars, and was fit using NUTS with a 'diag' metric</span></span>
<span><span class="co">#&gt; 1 chain(s) of 1150 total iterations (150 warmup) were used</span></span>
<span><span class="co">#&gt; Average run time per chain was 1.33 seconds </span></span>
<span><span class="co">#&gt; Minimum ESS=367.1 (36.71%), and maximum Rhat=1.01</span></span>
<span><span class="co">#&gt; There were 0 divergences after warmup</span></span>
<span><span class="va">post2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mcmc2</span><span class="op">)</span></span>
<span><span class="va">loglik2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">post2</span>,<span class="fl">1</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">obj2</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">loglik</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">loo2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">loglik2</span>, cores<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computed from 1000 by 578 log-likelihood matrix.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          Estimate   SE</span></span>
<span><span class="co">#&gt; elpd_loo  -2613.1 14.4</span></span>
<span><span class="co">#&gt; p_loo        31.8  3.0</span></span>
<span><span class="co">#&gt; looic      5226.2 28.9</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; MCSE of elpd_loo is NA.</span></span>
<span><span class="co">#&gt; MCSE and ESS estimates assume independent draws (r_eff=1).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pareto k diagnostic values:</span></span>
<span><span class="co">#&gt;                           Count Pct.    Min. ESS</span></span>
<span><span class="co">#&gt; (-Inf, 0.67]   (good)     577   99.8%   195     </span></span>
<span><span class="co">#&gt;    (0.67, 1]   (bad)        1    0.2%   &lt;NA&gt;    </span></span>
<span><span class="co">#&gt;     (1, Inf)   (very bad)   0    0.0%   &lt;NA&gt;    </span></span>
<span><span class="co">#&gt; See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="va">loo1</span>, <span class="va">loo2</span><span class="op">)</span></span>
<span><span class="co">#&gt;        elpd_diff se_diff</span></span>
<span><span class="co">#&gt; model1    0.0       0.0 </span></span>
<span><span class="co">#&gt; model2 -261.3      19.3</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="advanced-features">Advanced features<a class="anchor" aria-label="anchor" href="#advanced-features"></a>
</h2>
<div class="section level3">
<h3 id="adaptation-of-stan-diagonal-mass-matrix">Adaptation of Stan diagonal mass matrix<a class="anchor" aria-label="anchor" href="#adaptation-of-stan-diagonal-mass-matrix"></a>
</h3>
<p>When the estimate of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
does not well approximate the posterior surface, then it may be
advantageous to adapt a diagonal mass matrix to account for changes in
scale. This can be controlled via the <code>adapt_stan_metric</code>
argument. This argument is automatically set to FALSE when using a
metric other than ‘stan’ and ‘unit’ since all other metrics in theory
already descale the posterior. This can be overridden by setting it
equal to TRUE</p>
<p>Here I run three versions of the model and compare the NUTS stepsize.
The model version without adaptation uses a shorter warmup period</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">adapted1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj</span>, chains<span class="op">=</span><span class="fl">1</span>, seed<span class="op">=</span><span class="fl">1234</span>, refresh<span class="op">=</span><span class="fl">0</span>,</span>
<span>                        skip_optimization<span class="op">=</span><span class="cn">TRUE</span>, Q<span class="op">=</span><span class="va">Q</span>, Qinv<span class="op">=</span><span class="va">Sigma</span>,</span>
<span>                        metric<span class="op">=</span><span class="st">'auto'</span>, adapt_stan_metric <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Q is 92.58% zeroes, with condition factor=74028 (min=0.014, max=1018.9)</span></span>
<span><span class="co">#&gt; Rebuilding RTMB obj without random effects...</span></span>
<span><span class="co">#&gt; dense metric selected b/c faster than sparse and high correlation (max=0.81)</span></span>
<span><span class="co">#&gt; log-posterior at inits=(-2574.48); at conditional mode=-2574.481</span></span>
<span><span class="co">#&gt; Starting MCMC sampling...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Gradient evaluation took 0.000196 seconds</span></span>
<span><span class="co">#&gt; 1000 transitions using 10 leapfrog steps per transition would take 1.96 seconds.</span></span>
<span><span class="co">#&gt; Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Elapsed Time: 2.803 seconds (Warm-up)</span></span>
<span><span class="co">#&gt;                2.714 seconds (Sampling)</span></span>
<span><span class="co">#&gt;                5.517 seconds (Total)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 'RTMB' has 105 pars, and was fit using NUTS with a 'dense' metric</span></span>
<span><span class="co">#&gt; 1 chain(s) of 2000 total iterations (1000 warmup) were used</span></span>
<span><span class="co">#&gt; Average run time per chain was 5.52 seconds </span></span>
<span><span class="co">#&gt; Minimum ESS=282.3 (28.23%), and maximum Rhat=1.016</span></span>
<span><span class="co">#&gt; There were 0 divergences after warmup</span></span>
<span><span class="va">adapted2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj</span>, chains<span class="op">=</span><span class="fl">1</span>, seed<span class="op">=</span><span class="fl">1234</span>, refresh<span class="op">=</span><span class="fl">0</span>,</span>
<span>                     skip_optimization<span class="op">=</span><span class="cn">TRUE</span>, Q<span class="op">=</span><span class="va">Q</span>, Qinv<span class="op">=</span><span class="va">Sigma</span>,</span>
<span>                     metric<span class="op">=</span><span class="st">'stan'</span>, adapt_stan_metric <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rebuilding RTMB obj without random effects...</span></span>
<span><span class="co">#&gt; log-posterior at inits=(-2574.4)</span></span>
<span><span class="co">#&gt; Starting MCMC sampling...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Gradient evaluation took 0.000124 seconds</span></span>
<span><span class="co">#&gt; 1000 transitions using 10 leapfrog steps per transition would take 1.24 seconds.</span></span>
<span><span class="co">#&gt; Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Elapsed Time: 15.124 seconds (Warm-up)</span></span>
<span><span class="co">#&gt;                5.244 seconds (Sampling)</span></span>
<span><span class="co">#&gt;                20.368 seconds (Total)</span></span>
<span><span class="co">#&gt; Warning: The ESS has been capped to avoid unstable estimates.</span></span>
<span><span class="co">#&gt; Warning: The ESS has been capped to avoid unstable estimates.</span></span>
<span><span class="co">#&gt; Warning: The ESS has been capped to avoid unstable estimates.</span></span>
<span><span class="co">#&gt; Warning: The ESS has been capped to avoid unstable estimates.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 'RTMB' has 105 pars, and was fit using NUTS with a 'stan' metric</span></span>
<span><span class="co">#&gt; 1 chain(s) of 2000 total iterations (1000 warmup) were used</span></span>
<span><span class="co">#&gt; Average run time per chain was 20.37 seconds </span></span>
<span><span class="co">#&gt; Minimum ESS=345.8 (34.58%), and maximum Rhat=1.016</span></span>
<span><span class="co">#&gt; There were 0 divergences after warmup</span></span>
<span><span class="va">sp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_sampler_params.html">extract_sampler_params</a></span><span class="op">(</span><span class="va">mcmc</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">iteration</span> <span class="op">&lt;=</span> <span class="fl">1050</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">'descaled + not adapted'</span><span class="op">)</span></span>
<span><span class="va">sp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_sampler_params.html">extract_sampler_params</a></span><span class="op">(</span><span class="va">adapted1</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">iteration</span> <span class="op">&lt;=</span> <span class="fl">1050</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">'descaled + adapted'</span><span class="op">)</span></span>
<span><span class="va">sp3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_sampler_params.html">extract_sampler_params</a></span><span class="op">(</span><span class="va">adapted2</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">iteration</span> <span class="op">&lt;=</span> <span class="fl">1050</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">'adapted'</span><span class="op">)</span></span>
<span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sp1</span>, <span class="va">sp2</span>, <span class="va">sp3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">iteration</span>, y<span class="op">=</span><span class="va">stepsize__</span>, color<span class="op">=</span><span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'top'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color<span class="op">=</span><span class="cn">NULL</span>, x<span class="op">=</span><span class="st">'warmup'</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" alt="" width="700"></p>
<p>It is apparent that during the first warmup phase the model with Stan
defaults (‘adapted’ in the above plot) has a large adjustment in
stepsize and this corresponds to very long trajectory lengths and thus
increased computational time. If descaled using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
the adaptation does nothing (‘descaled + adapted’), which is why such a
short warmup period can be used with SNUTS (‘descaled + not adapted’) in
this case, and often which is why the default warmup is short and
adaptation disabled for SNUTS.</p>
<p>In other cases a longer warmup and mass matrix adaptation will make a
difference, see for example the ‘wildf’ model in <span class="citation">C. C. Monnahan et al. (in prep)</span>.</p>
</div>
<div class="section level3">
<h3 id="embedded-laplace-approximation-snuts">Embedded Laplace approximation SNUTS<a class="anchor" aria-label="anchor" href="#embedded-laplace-approximation-snuts"></a>
</h3>
<p>This approach uses NUTS (or SNUTS) to sample from the marginal
posterior using the Laplace approximation to integrate the random
effects. This was first explored in <span class="citation">(C. C.
Monnahan and Kristensen 2018)</span> and later in more detail in <span class="citation">(Margossian et al. 2020)</span> who called it the
‘embedded Laplace approximation’. <span class="citation">(C. C. Monnahan
et al. in prep)</span> applied this to a much larger set of models and
found mixed results.</p>
<p>It is trivial to try in SNUTS by simply declaring
<code>laplace=TRUE</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ela</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj</span>, chains<span class="op">=</span><span class="fl">1</span>, laplace<span class="op">=</span><span class="cn">TRUE</span>, refresh<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Optimizing...</span></span>
<span><span class="co">#&gt; Getting M for fixed effects...</span></span>
<span><span class="co">#&gt; Qinv is 0% zeroes, with condition factor=3107 (min=0.001, max=3.3)</span></span>
<span><span class="co">#&gt; diag metric selected b/c low correlations (max=0.1458)</span></span>
<span><span class="co">#&gt; log-posterior at inits=(-2451.94); at conditional mode=-2451.942</span></span>
<span><span class="co">#&gt; Starting MCMC sampling...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Gradient evaluation took 0.000867 seconds</span></span>
<span><span class="co">#&gt; 1000 transitions using 10 leapfrog steps per transition would take 8.67 seconds.</span></span>
<span><span class="co">#&gt; Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Elapsed Time: 1.45 seconds (Warm-up)</span></span>
<span><span class="co">#&gt;                8.379 seconds (Sampling)</span></span>
<span><span class="co">#&gt;                9.829 seconds (Total)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 'RTMB' has 5 pars, and was fit using NUTS with a 'diag' metric</span></span>
<span><span class="co">#&gt; 1 chain(s) of 1150 total iterations (150 warmup) were used</span></span>
<span><span class="co">#&gt; Average run time per chain was 9.83 seconds </span></span>
<span><span class="co">#&gt; Minimum ESS=540.4 (54.04%), and maximum Rhat=1.001</span></span>
<span><span class="co">#&gt; There were 0 divergences after warmup</span></span></code></pre></div>
<p>Here I can see there are only 5 model parameters (the fixed effects),
and that a diagonal metric was chosen due to minimal correlations among
these parameters. ELA will typically take longer to run, but have higher
minESS and so it is best to compare the efficiency (minESS per time)
which I do not do here.</p>
<p>Exploring ELA is a good opportunity to show how SNUTS can fail. I
demonstrate this with the notoriously difficult ‘funnel’ model which is
a hierarchical model without any data. This model has strongly varying
curvature and thus is <strong>not</strong> well-approximated by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
so SNUTS mixes poorly. But after turning on ELA, it mixes fine and
recovers the</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Funnel example ported to RTMB from</span></span>
<span><span class="co"># https://mc-stan.org/docs/cmdstan-guide/diagnose_utility.html#running-the-diagnose-command</span></span>
<span><span class="co">## the (negative) posterior density as a function in R</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span>
<span>  <span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">0</span>, <span class="fl">3</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="co"># prior</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">y</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="co"># likelihood</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">lp</span><span class="op">)</span> <span class="co"># TMB expects negative log posterior</span></span>
<span><span class="op">}</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">RTMB</span><span class="fu">::</span><span class="fu">MakeADFun</span><span class="op">(</span><span class="va">f</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y<span class="op">=</span><span class="op">-</span><span class="fl">1.12</span>, x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">9</span><span class="op">)</span><span class="op">)</span>, random<span class="op">=</span><span class="st">'x'</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Now SNUTS</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj</span>, seed<span class="op">=</span><span class="fl">1213</span>, refresh<span class="op">=</span><span class="fl">0</span>, init<span class="op">=</span><span class="st">'random'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Optimizing...</span></span>
<span><span class="co">#&gt; Getting Q...</span></span>
<span><span class="co">#&gt; Inverting Q...</span></span>
<span><span class="co">#&gt; Q is 100% zeroes, with condition factor=9 (min=0.111, max=1)</span></span>
<span><span class="co">#&gt; Rebuilding RTMB obj without random effects...</span></span>
<span><span class="co">#&gt; diag metric selected b/c of low correlations (max=0)</span></span>
<span><span class="co">#&gt; log-posterior at inits=(-237.12,-23.12,-37.52,-20.55); at conditional mode=-10.288</span></span>
<span><span class="co">#&gt; Starting MCMC sampling...</span></span>
<span><span class="co">#&gt; Preparing parallel workspace...</span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.000241 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 2.41 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 0.000226 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 2.26 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 0.000249 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 2.49 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 0.000213 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 2.13 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 1.778 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                8.337 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                10.115 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 4.922 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                12.589 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                17.511 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 1.955 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                17.867 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                19.822 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 1.416 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                24.071 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                25.487 seconds (Total)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 'RTMB' has 10 pars, and was fit using NUTS with a 'diag' metric</span></span>
<span><span class="co">#&gt; 4 chain(s) of 1150 total iterations (150 warmup) were used</span></span>
<span><span class="co">#&gt; Average run time per chain was 18.23 seconds </span></span>
<span><span class="co">#&gt; Minimum ESS=44.4 (1.11%), and maximum Rhat=1.081</span></span>
<span><span class="co">#&gt; !! Warning: Signs of non-convergence found. Do not use for inference !!</span></span>
<span><span class="co">#&gt; There were 9 divergences after warmup</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">fit</span>, pars<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/funnel-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># hasn't recovered the prior b/c it's not converged, particularly</span></span>
<span><span class="co"># for small y values</span></span>
<span><span class="va">post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">y</span>, freq<span class="op">=</span><span class="cn">FALSE</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>,<span class="fl">10</span>, len<span class="op">=</span><span class="fl">200</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">mle</span><span class="op">$</span><span class="va">est</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, col<span class="op">=</span><span class="fl">2</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/funnel-2.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Now turn on ELA and it easily recovers the prior on y</span></span>
<span><span class="va">fit.ela</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj</span>, laplace<span class="op">=</span><span class="cn">TRUE</span>, refresh<span class="op">=</span><span class="fl">0</span>, init<span class="op">=</span><span class="st">'random'</span>, seed<span class="op">=</span><span class="fl">12312</span><span class="op">)</span></span>
<span><span class="co">#&gt; Optimizing...</span></span>
<span><span class="co">#&gt; Getting M for fixed effects...</span></span>
<span><span class="co">#&gt; diag metric selected b/c only 1 parameter</span></span>
<span><span class="co">#&gt; log-posterior at inits=(-2.68,-2.25,-2.1,-2.08); at conditional mode=-2.018</span></span>
<span><span class="co">#&gt; Starting MCMC sampling...</span></span>
<span><span class="co">#&gt; Preparing parallel workspace...</span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.053637 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 536.37 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 0.088837 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 888.37 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 0.040962 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 409.62 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 0.046713 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 467.13 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 0.659 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                3.772 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                4.431 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 0.751 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                3.88 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                4.631 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 0.704 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                3.445 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                4.149 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 0.849 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                3.613 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                4.462 seconds (Total)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 'RTMB' has 1 pars, and was fit using NUTS with a 'diag' metric</span></span>
<span><span class="co">#&gt; 4 chain(s) of 1150 total iterations (150 warmup) were used</span></span>
<span><span class="co">#&gt; Average run time per chain was 4.42 seconds </span></span>
<span><span class="co">#&gt; Minimum ESS=1705.7 (42.64%), and maximum Rhat=1.001</span></span>
<span><span class="co">#&gt; There were 0 divergences after warmup</span></span>
<span><span class="co"># you just get the prior back b/c the Laplace approximation is</span></span>
<span><span class="co"># accurate</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">fit.ela</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post.ela</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">fit.ela</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">post.ela</span><span class="op">$</span><span class="va">y</span>, freq<span class="op">=</span><span class="cn">FALSE</span>, breaks<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>,<span class="fl">10</span>, len<span class="op">=</span><span class="fl">200</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/unnamed-chunk-9-2.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level3">
<h3 id="linking-to-other-stan-algorithms-via-stanestimators">Linking to other Stan algorithms via StanEstimators<a class="anchor" aria-label="anchor" href="#linking-to-other-stan-algorithms-via-stanestimators"></a>
</h3>
<p><code>sample_snuts</code> links to the
<code><a href="https://andrjohns.github.io/StanEstimators/reference/stan_sample.html" class="external-link">StanEstimators::stan_sample</a></code> function for NUTS sampling.
However, this package provides other algorithms given a model and these
may be of interest to some users. I focus on the Pathfinder algorithm
and an RTMB model.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Construct a joint model (no random effects)</span></span>
<span><span class="va">obj2</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span>func<span class="op">=</span><span class="va">obj</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">data</span>, parameters<span class="op">=</span><span class="va">obj</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="fu">parList</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                  map<span class="op">=</span><span class="va">obj</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">map</span>, random<span class="op">=</span><span class="cn">NULL</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># TMB does negative log densities so convert to form used by Stan</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="va">obj2</span><span class="op">$</span><span class="fu">fn</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">grad_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="va">obj2</span><span class="op">$</span><span class="fu">gr</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">pf</span> <span class="op">&lt;-</span> <span class="fu">StanEstimators</span><span class="fu">::</span><span class="fu"><a href="https://andrjohns.github.io/StanEstimators/reference/stan_pathfinder.html" class="external-link">stan_pathfinder</a></span><span class="op">(</span>fn<span class="op">=</span><span class="va">fn</span>, grad_fun<span class="op">=</span><span class="va">grad_fun</span>, refresh<span class="op">=</span><span class="fl">100</span>,</span>
<span>                      par_inits <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par.best</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Path [1] :Initial log joint density = -10.287998</span></span>
<span><span class="co">#&gt; Path [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes </span></span>
<span><span class="co">#&gt;               2       8.084e+01      3.600e+01   4.441e-15    1.000e+00  1.000e+00        62 -4.834e+01 -8.495e+19                  </span></span>
<span><span class="co">#&gt; Path [1] :Best Iter: [1] ELBO (-48.343445) evaluations: (62)</span></span>
<span><span class="co">#&gt; Path [2] :Initial log joint density = -10.287998</span></span>
<span><span class="co">#&gt; Path [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes </span></span>
<span><span class="co">#&gt;               2       8.084e+01      3.600e+01   4.441e-15    1.000e+00  1.000e+00        62 -3.798e+01 -2.018e+20                  </span></span>
<span><span class="co">#&gt; Path [2] :Best Iter: [1] ELBO (-37.983612) evaluations: (62)</span></span>
<span><span class="co">#&gt; Path [3] :Initial log joint density = -10.287998</span></span>
<span><span class="co">#&gt; Path [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes </span></span>
<span><span class="co">#&gt;               2       8.084e+01      3.600e+01   4.441e-15    1.000e+00  1.000e+00        62 -4.057e+01 -6.022e+19                  </span></span>
<span><span class="co">#&gt; Path [3] :Best Iter: [1] ELBO (-40.568960) evaluations: (62)</span></span>
<span><span class="co">#&gt; Path [4] :Initial log joint density = -10.287998</span></span>
<span><span class="co">#&gt; Path [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes </span></span>
<span><span class="co">#&gt;               2       8.084e+01      3.600e+01   4.441e-15    1.000e+00  1.000e+00        62 -4.244e+01 -2.433e+20                  </span></span>
<span><span class="co">#&gt; Path [4] :Best Iter: [1] ELBO (-42.440460) evaluations: (62)</span></span>
<span><span class="co">#&gt; Pareto k value (1.8) is greater than 0.7. Importance resampling was not able to improve the approximation, which may indicate that the approximation itself is poor.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="linking-to-other-bayesian-tools">Linking to other Bayesian tools<a class="anchor" aria-label="anchor" href="#linking-to-other-bayesian-tools"></a>
</h3>
<p>It is straightforward to pass <code>SparseNUTS</code> output into
other Bayesian R packages. I demonstrate this with
<code>bayesplot</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is bayesplot version 1.15.0</span></span>
<span><span class="co">#&gt; - Online documentation and vignettes at mc-stan.org/bayesplot</span></span>
<span><span class="co">#&gt; - bayesplot theme set to bayesplot::theme_default()</span></span>
<span><span class="co">#&gt;    * Does _not_ affect other ggplot2 plots</span></span>
<span><span class="co">#&gt;    * See ?bayesplot_theme_set for details on theme setting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="va">post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">)</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="va">mcmc</span><span class="op">$</span><span class="va">par_names</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-intervals.html" class="external-link">mcmc_areas</a></span><span class="op">(</span><span class="va">post</span>, pars<span class="op">=</span><span class="va">pars</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/bayesplot-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_trace</a></span><span class="op">(</span><span class="va">post</span>, pars<span class="op">=</span><span class="va">pars</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/bayesplot-2.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/bayesplot-colors.html" class="external-link">color_scheme_set</a></span><span class="op">(</span><span class="st">"red"</span><span class="op">)</span></span>
<span><span class="va">np</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_sampler_params.html">extract_sampler_params</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">chain</span>, <span class="va">iteration</span><span class="op">)</span>, names_to<span class="op">=</span><span class="st">'Parameter'</span>, values_to<span class="op">=</span><span class="st">'Value'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>Iteration<span class="op">=</span><span class="va">iteration</span>, <span class="va">Parameter</span>, <span class="va">Value</span>, Chain<span class="op">=</span><span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Parameter<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Parameter</span><span class="op">)</span>,</span>
<span>         Iteration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">Iteration</span><span class="op">)</span>,</span>
<span>         Chain<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">Chain</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-nuts.html" class="external-link">mcmc_nuts_energy</a></span><span class="op">(</span><span class="va">np</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"NUTS Energy Diagnostic"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value `binwidth`.</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value `binwidth`.</span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/bayesplot-3.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># finally, posterior predictive for first 24 observations</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/PPC-intervals.html" class="external-link">ppc_intervals</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">ChickWeight</span><span class="op">$</span><span class="va">weight</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">]</span>, yrep<span class="op">=</span><span class="va">simdat</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The deprecated feature was likely used in the <span style="color: #0000BB;">bayesplot</span> package.</span></span>
<span><span class="co">#&gt;   Please report the issue at <span style="color: #0000BB; font-style: italic;">&lt;https://github.com/stan-dev/bayesplot/issues/&gt;</span>.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once per session.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p><img src="advanced-usage_files/figure-html/bayesplot-4.png" class="r-plt" alt="" width="700"></p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-margossian2020" class="csl-entry">
Margossian, Charles, Aki Vehtari, Daniel Simpson, and Raj Agrawal. 2020.
<span>“Hamiltonian <span>M</span>onte <span>C</span>arlo Using an
Adjoint-Differentiated <span>L</span>aplace Approximation:
<span>B</span>ayesian Inference for Latent <span>G</span>aussian Models
and Beyond.”</span> In <em>Advances in <span>N</span>eural
<span>I</span>nformation <span>P</span>rocessing
<span>S</span>ystems</em>, edited by H. Larochelle, M. Ranzato, R.
Hadsell, M. F. Balcan, and H. Lin, 33:9086–97. Curran Associates, Inc.
<a href="https://proceedings.neurips.cc/paper_files/paper/2020/file/673de96b04fa3adcae1aacda704217ef-Paper.pdf" class="external-link">https://proceedings.neurips.cc/paper_files/paper/2020/file/673de96b04fa3adcae1aacda704217ef-Paper.pdf</a>.
</div>
<div id="ref-monnahan2018" class="csl-entry">
Monnahan, C. C, and Kasper Kristensen. 2018. <span>“No-u-Turn Sampling
for Fast Bayesian Inference in ADMB and TMB: Introducing the Adnuts and
Tmbstan r Packages.”</span> <em>PloS One</em> 13 (5).
</div>
<div id="ref-monnahan2025" class="csl-entry">
Monnahan, C. C., Thorson J. T., K. Kristensen, and B. Carpenter. in
prep. <span>“Leveraging Sparsity to Improve No-u-Turn Sampling
Efficiency for Hierarchical Bayesian Models.”</span> <em>arXiv
Preprint</em>, in prep.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Cole Monnahan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
