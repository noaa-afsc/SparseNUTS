<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to SparseNUTS • SparseNUTS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Introduction to SparseNUTS">
<meta name="description" content="Learn how to get started with the basics of SparseNUTS
">
<meta property="og:description" content="Learn how to get started with the basics of SparseNUTS
">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SparseNUTS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/SparseNUTS.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/advanced-usage.html">Advanced usage</a></li>
    <li><a class="dropdown-item" href="../articles/Implementing-bounds.html">Implementing parameter transformations in SNUTS</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/noaa-afsc/SparseNUTS/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Introduction to SparseNUTS</h1>
                        <h4 data-toc-skip class="author">Cole C.
Monnahan</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/noaa-afsc/SparseNUTS/blob/v1.0.0/vignettes/SparseNUTS.Rmd" class="external-link"><code>vignettes/SparseNUTS.Rmd</code></a></small>
      <div class="d-none name"><code>SparseNUTS.Rmd</code></div>
    </div>

    
    
<p>The goal of SparseNUTS is to provide a user-friendly workflow for
users of TMB and RTMB who want to implement the sparse no-u-turn sampler
<span class="citation">(C. C. Monnahan et al. in prep)</span> to draw
samples from a model.</p>
<p>This package was originally developed inside of the <a href="https://github.com/Cole-Monnahan-NOAA/adnuts" class="external-link">adnuts</a> package
but was split off in late 2025 to have a dedicated package for
SparseNUTS for TMB and RTMB models. The <code>tmbstan</code> package
also provides an interface to the Stan software, but lacks the ability
to decorrelate the target distribution prior to sampling.
<code>SparseNUTS</code> provides more flexible options related to the
mass matrix.</p>
<div class="section level2">
<h2 id="differences-in-usage-between-tmb-and-rtmb">Differences in usage between TMB and RTMB<a class="anchor" aria-label="anchor" href="#differences-in-usage-between-tmb-and-rtmb"></a>
</h2>
<p>Both TMB and RTMB models can be used with minimal user intervention,
including running parallel chains. The <code>sample_snuts</code>
function will detect which package is used internally and adjust
accordingly. If the user wants to use models from both packages in the
same session then one needs to be unloaded, e.g.,
<code>if('TMB' %in% .packages()) detach(package:TMB)</code>, before the
other package is loaded.</p>
<p>If the RTMB model uses external functions or data sets then they must
be passed through via a list in the <code>globals</code> argument so
they are available to rebuild the ‘obj’ in the parallel R sessions.
Optionally, the <code>model_name</code> can be specified in the call,
otherwise your model will be labeled “RTMB” in the output. TMB models do
not require a globals input and the model name is pulled from the DLL
name, but can be overridden if desired.</p>
</div>
<div class="section level2">
<h2 id="comparison-to-tmbstan">Comparison to tmbstan<a class="anchor" aria-label="anchor" href="#comparison-to-tmbstan"></a>
</h2>
<p>The related package ‘tmbstan’ <span class="citation">(C. C. Monnahan
and Kristensen 2018)</span> also allows users to link TMB models to the
Stan algorithms. ‘tmbstan’ links through the package ‘rstan’, while
‘SparseNUTS’ modifies the objective and gradient functions and then
passes those to ‘cmdstan’ through the ‘StanEstimators’ R package
interface. For models without large correlations or scale differences,
<code>tmbstan</code> is likely to be faster than ‘SparseNUTS’ due to
lower overhead and may be a better option. Eventually, Stan may add
SNUTS functionality and an interface to ‘tmbstan’ developed, and in that
case <code>tmbstan</code> may be a better long term option. For TMB
users now, SNUTS via <code>SparseNUTS</code> is likely to be the best
overall package for Bayesian inference.</p>
</div>
<div class="section level2">
<h2 id="snuts-for-tmb-models-from-existing-packages-sdmtmb-glmmtmb-etc-">SNUTS for TMB models from existing packages (sdmTMB, glmmTMB,
etc.)<a class="anchor" aria-label="anchor" href="#snuts-for-tmb-models-from-existing-packages-sdmtmb-glmmtmb-etc-"></a>
</h2>
<p><code>SparseNUTS</code> works for custom TMB and RTMB models
developed locally, but also for those that come in packages. Most
packages will return the TMB ‘obj’ which can then be passed into
<code>sample_snuts</code>.</p>
<p>For instance the <code>glmmTMB</code> package can be run like
this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/glmmTMB/glmmTMB" class="external-link">glmmTMB</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://noaa-afsc.github.io/SparseNUTS">SparseNUTS</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Salamanders</span><span class="op">)</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">glmmTMB</span><span class="op">(</span><span class="va">count</span><span class="op">~</span><span class="va">spp</span> <span class="op">*</span> <span class="va">mined</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span>, <span class="va">Salamanders</span>, family<span class="op">=</span><span class="st">"nbinom2"</span><span class="op">)</span><span class="op">$</span><span class="va">obj</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<p>The recommended usage for TMB users is to let the
<code>sample_snuts</code> function automatically detect the metric to
use and the length of warmup period, especially for pilot runs during
model development.</p>
<p>I demonstrate basic usage using a very simple RTMB version of the
eight schools model that has been examined extensively in the Bayesian
literature. The first step is to build the TMB object ‘obj’ that
incorporates priors and Jacobians for parameter transformations. Note
that the R function returns the negative un-normalized log-posterior
density.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kaskr/RTMB" class="external-link">RTMB</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://noaa-afsc.github.io/SparseNUTS">SparseNUTS</a></span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28</span>,  <span class="fl">8</span>, <span class="op">-</span><span class="fl">3</span>,  <span class="fl">7</span>, <span class="op">-</span><span class="fl">1</span>,  <span class="fl">1</span>, <span class="fl">18</span>, <span class="fl">12</span><span class="op">)</span>,</span>
<span>            sigma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">10</span>, <span class="fl">16</span>, <span class="fl">11</span>,  <span class="fl">9</span>, <span class="fl">11</span>, <span class="fl">10</span>, <span class="fl">18</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mu<span class="op">=</span><span class="fl">0</span>, logtau<span class="op">=</span><span class="fl">0</span>, eta<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">getAll</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">pars</span><span class="op">)</span></span>
<span>  <span class="va">theta</span> <span class="op">&lt;-</span> <span class="va">mu</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logtau</span><span class="op">)</span> <span class="op">*</span> <span class="va">eta</span>;</span>
<span>  <span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">eta</span>, <span class="fl">0</span>,<span class="fl">1</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="co"># prior</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>,<span class="va">theta</span>,<span class="va">sigma</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="co">#likelihood</span></span>
<span>    <span class="va">logtau</span>                          <span class="co"># jacobian</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RTMB/man/TMB-interface.html" class="external-link">REPORT</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">lp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">MakeADFun</span><span class="op">(</span>func<span class="op">=</span><span class="va">f</span>, parameters<span class="op">=</span><span class="va">pars</span>,</span>
<span>                 random<span class="op">=</span><span class="st">"eta"</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="posterior-sampling-with-snuts">Posterior sampling with SNUTS<a class="anchor" aria-label="anchor" href="#posterior-sampling-with-snuts"></a>
</h3>
<p>The most common task is to draw samples from the posterior density
defined by this model. This is done with the <code>sample_snuts</code>
function as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_snuts.html">sample_snuts</a></span><span class="op">(</span><span class="va">obj</span>, refresh<span class="op">=</span><span class="fl">0</span>, seed<span class="op">=</span><span class="fl">1</span>,</span>
<span>                    model_name <span class="op">=</span> <span class="st">'schools'</span>,</span>
<span>                    cores<span class="op">=</span><span class="fl">1</span>, chains<span class="op">=</span><span class="fl">1</span>,</span>
<span>                    globals<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Optimizing...</span></span></code></pre>
<pre><code><span><span class="co">## Getting Q...</span></span></code></pre>
<pre><code><span><span class="co">## Inverting Q...</span></span></code></pre>
<pre><code><span><span class="co">## Q is 62.22% zeroes, with condition factor=56 (min=0.044, max=2.5)</span></span></code></pre>
<pre><code><span><span class="co">## Rebuilding RTMB obj without random effects...</span></span></code></pre>
<pre><code><span><span class="co">## diag metric selected b/c of low correlations (max=0.2927)</span></span></code></pre>
<pre><code><span><span class="co">## log-posterior at inits=(-34.66); at conditional mode=-34.661</span></span></code></pre>
<pre><code><span><span class="co">## Starting MCMC sampling...</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Gradient evaluation took 8.2e-05 seconds</span></span>
<span><span class="co">## 1000 transitions using 10 leapfrog steps per transition would take 0.82 seconds.</span></span>
<span><span class="co">## Adjust your expectations accordingly!</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Elapsed Time: 0.098 seconds (Warm-up)</span></span>
<span><span class="co">##                0.605 seconds (Sampling)</span></span>
<span><span class="co">##                0.703 seconds (Total)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model 'schools' has 10 pars, and was fit using NUTS with a 'diag' metric</span></span>
<span><span class="co">## 1 chain(s) of 1150 total iterations (150 warmup) were used</span></span>
<span><span class="co">## Average run time per chain was 0.7 seconds </span></span>
<span><span class="co">## Minimum ESS=265.6 (26.56%), and maximum Rhat=1.003</span></span>
<span><span class="co">## There were 0 divergences after warmup</span></span></code></pre>
<p>The returned object <code>fit</code> (an object of ‘adfit’ S3 class)
contains the posterior samples and other relevant information for a
Bayesian analysis.</p>
<p>Here a ‘diag’ (diagonal) metric is selected and a very short warmup
period of 150 iterations is used, with mass matrix adaptation in Stan
disabled. See below for more details on mass matrix adaptation within
Stan.</p>
<p>Notice that no optimization was done before calling
<code>sample_snuts</code>. When the model has already been optimized,
you can skip that by setting <code>skip_optimization=TRUE</code>, and
even pass in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Σ</mi><mo>=</mo><msup><mi>Q</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\Sigma=Q^{-1}</annotation></semantics></math>
via arguments <code>Q</code> and <code>Qinv</code> to bypass this step
and save some run time. This may also be required if the model
optimization routine internal to <code>sample_snuts</code> is
insufficient. In that case, the user should optimize prior to SNUTS
sampling. The returned fitted object contains a slot called
<code>mle</code> (for maximum likelihood estimates) which has the
conditional mode (‘est’), the marginal standard errors ‘se’, a joint
correlation matrix (‘cor’), and the sparse precision matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">mle</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 5</span></span>
<span><span class="co">##  $ nopar: int 10</span></span>
<span><span class="co">##  $ est  : Named num [1:10] 7.92441 1.8414 0.47811 0.00341 -0.2329 ...</span></span>
<span><span class="co">##   ..- attr(*, "names")= chr [1:10] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span>
<span><span class="co">##  $ se   : Named num [1:10] 4.725 0.732 0.959 0.872 0.945 ...</span></span>
<span><span class="co">##   ..- attr(*, "names")= chr [1:10] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span>
<span><span class="co">##  $ cor  : num [1:10, 1:10] 1 0.0558 -0.1031 -0.2443 -0.114 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:10] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:10] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span>
<span><span class="co">##  $ Q    :Formal class 'dsCMatrix' [package "Matrix"] with 7 slots</span></span>
<span><span class="co">##   .. ..@ i       : int [1:27] 0 1 2 3 4 5 6 7 8 9 ...</span></span>
<span><span class="co">##   .. ..@ p       : int [1:11] 0 10 19 20 21 22 23 24 25 26 ...</span></span>
<span><span class="co">##   .. ..@ Dim     : int [1:2] 10 10</span></span>
<span><span class="co">##   .. ..@ Dimnames:List of 2</span></span>
<span><span class="co">##   .. .. ..$ : chr [1:10] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span>
<span><span class="co">##   .. .. ..$ : chr [1:10] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span>
<span><span class="co">##   .. ..@ x       : num [1:27] 0.0603 -0.0144 0.028 0.0631 0.0246 ...</span></span>
<span><span class="co">##   .. ..@ uplo    : chr "L"</span></span>
<span><span class="co">##   .. ..@ factors :List of 1</span></span>
<span><span class="co">##   .. .. ..$ SPdCholesky:Formal class 'dCHMsuper' [package "Matrix"] with 10 slots</span></span>
<span><span class="co">##   .. .. .. .. ..@ x       : num [1:100] 1.06 0 0 0 0 ...</span></span>
<span><span class="co">##   .. .. .. .. ..@ super   : int [1:2] 0 10</span></span>
<span><span class="co">##   .. .. .. .. ..@ pi      : int [1:2] 0 10</span></span>
<span><span class="co">##   .. .. .. .. ..@ px      : int [1:2] 0 100</span></span>
<span><span class="co">##   .. .. .. .. ..@ s       : int [1:10] 0 1 2 3 4 5 6 7 8 9</span></span>
<span><span class="co">##   .. .. .. .. ..@ type    : int [1:6] 2 1 1 1 1 1</span></span>
<span><span class="co">##   .. .. .. .. ..@ colcount: int [1:10] 3 3 3 3 3 3 4 3 2 1</span></span>
<span><span class="co">##   .. .. .. .. ..@ perm    : int [1:10] 9 8 7 6 5 4 0 2 3 1</span></span>
<span><span class="co">##   .. .. .. .. ..@ Dim     : int [1:2] 10 10</span></span>
<span><span class="co">##   .. .. .. .. ..@ Dimnames:List of 2</span></span>
<span><span class="co">##   .. .. .. .. .. ..$ : chr [1:10] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span>
<span><span class="co">##   .. .. .. .. .. ..$ : chr [1:10] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h3>
<p>The common MCMC diagnostics potential scale reduction (Rhat) and
minimum ESS, as well as the NUTS divergences (see <a href="https://mc-stan.org/docs/reference-manual/analysis.html" class="external-link">diagnostics
section</a> of the rstan manual), are printed to console by default or
can be accessed in more depth via the <code>monitor</code> slot:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Model 'schools' has 10 pars, and was fit using NUTS with a 'diag' metric</span></span>
<span><span class="co">## 1 chain(s) of 1150 total iterations (150 warmup) were used</span></span>
<span><span class="co">## Average run time per chain was 0.7 seconds </span></span>
<span><span class="co">## Minimum ESS=265.6 (26.56%), and maximum Rhat=1.003</span></span>
<span><span class="co">## There were 0 divergences after warmup</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">monitor</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## drws_smm [11 × 10] (S3: draws_summary/tbl_df/tbl/data.frame)</span></span>
<span><span class="co">##  $ variable: chr [1:11] "mu" "logtau" "eta[1]" "eta[2]" ...</span></span>
<span><span class="co">##  $ mean    : num [1:11] 7.8963 1.3284 0.3436 0.0114 -0.1834 ...</span></span>
<span><span class="co">##  $ median  : num [1:11] 7.5789 1.6113 0.399 0.0223 -0.1674 ...</span></span>
<span><span class="co">##  $ sd      : num [1:11] 4.767 1.161 0.972 0.834 0.863 ...</span></span>
<span><span class="co">##  $ mad     : num [1:11] 4.513 1.051 0.989 0.782 0.84 ...</span></span>
<span><span class="co">##  $ q5      : num [1:11] 0.246 -1.01 -1.286 -1.344 -1.569 ...</span></span>
<span><span class="co">##  $ q95     : num [1:11] 15.75 2.82 1.85 1.36 1.26 ...</span></span>
<span><span class="co">##  $ rhat    : num [1:11] 1 1.001 0.999 1 1 ...</span></span>
<span><span class="co">##  $ ess_bulk: num [1:11] 746 309 1354 1164 1063 ...</span></span>
<span><span class="co">##  $ ess_tail: num [1:11] 534 502 692 704 603 ...</span></span>
<span><span class="co">##  - attr(*, "num_args")= list()</span></span></code></pre>
<p>A specialized <code>pairs</code> plotting function is available
(formally called <code>pairs_admb</code>) to examine pair-wise behavior
of the posteriors. This can be useful to help diagnose particularly slow
mixing parameters. This function also displays the conditional mode
(point) and 95% bivariate confidence region (ellipses) as calculated
from the approximate covariance matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Σ</mi><mo>=</mo><msup><mi>Q</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\Sigma=Q^{-1}</annotation></semantics></math>.
The parameters to show can be specified either vie a character vector
like <code>pars=c('mu', 'logtau', 'eta[1]')</code> or an integer vector
like <code>pars=1:3</code>, and when using the latter the parameters can
be ordered by slowest mixing (‘slow’), fastest mixing (‘fast’) or by the
largest discrepancies in the approximate marginal variance from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
and the posterior samples (‘mismatch’). NUTS divergences are shown as
green points. See help and further information at
<code>?pairs.adfit</code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">fit</span>, order<span class="op">=</span><span class="st">'slow'</span><span class="op">)</span></span></code></pre></div>
<p><img src="SparseNUTS_files/figure-html/pairs-schools-1.png" class="r-plt" alt="" width="700"></p>
<p>In some cases it is useful to diagnose the NUTS behavior by examining
the “sampler parameters”, which contain information about the individual
NUTS trajectories.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extract_sampler_params.html">extract_sampler_params</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    1000 obs. of  8 variables:</span></span>
<span><span class="co">##  $ chain        : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ iteration    : num  151 152 153 154 155 156 157 158 159 160 ...</span></span>
<span><span class="co">##  $ accept_stat__: num  0.281 0.384 0.116 0.781 0.945 ...</span></span>
<span><span class="co">##  $ stepsize__   : num  0.492 0.492 0.492 0.492 0.492 ...</span></span>
<span><span class="co">##  $ treedepth__  : num  3 3 3 2 3 3 3 2 2 3 ...</span></span>
<span><span class="co">##  $ n_leapfrog__ : num  7 7 7 7 7 7 7 7 3 7 ...</span></span>
<span><span class="co">##  $ divergent__  : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##  $ energy__     : num  39.3 39.5 41.9 44.3 45.6 ...</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## or plot them directly</span></span>
<span><span class="fu"><a href="../reference/plot_sampler_params.html">plot_sampler_params</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<p><img src="SparseNUTS_files/figure-html/sp-schools-1.png" class="r-plt" alt="" width="700"></p>
<p>The ShinyStan tool is also available and provides a convenient,
interactive way to check diagnostics via the function
<code><a href="../reference/launch_shinytmb.html">launch_shinytmb()</a></code>, but also explore estimates and other
important quantities. This is a valuable tool for a workflow with
‘SparseNUTS’.</p>
</div>
<div class="section level3">
<h3 id="bayesian-inference">Bayesian inference<a class="anchor" aria-label="anchor" href="#bayesian-inference"></a>
</h3>
<p>After checking for signs of non-convergence the results can be used
for inference. Posterior samples for parameters can be extracted and
examined in R by casting the fitted object to an R data.frame. These
posterior samples can then be put back into the TMB object
<code>obj$report()</code> function to extract any desired “generated
quantity” in Stan terminology. Below is a demonstration of how to do
this for the quantity theta (a vector of length 8).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">post</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    1000 obs. of  10 variables:</span></span>
<span><span class="co">##  $ mu    : num  12.01 9.87 4.4 10.34 4.88 ...</span></span>
<span><span class="co">##  $ logtau: num  3.328 3.605 -1.271 -0.259 2.178 ...</span></span>
<span><span class="co">##  $ eta[1]: num  1.026 1.319 -0.646 -2.113 -0.642 ...</span></span>
<span><span class="co">##  $ eta[2]: num  0.513 -0.215 0.132 0.175 0.961 ...</span></span>
<span><span class="co">##  $ eta[3]: num  0.04341 -0.44468 -0.01319 -0.30872 -0.00504 ...</span></span>
<span><span class="co">##  $ eta[4]: num  -0.0476 -0.3879 -0.2872 -1.1967 -0.4708 ...</span></span>
<span><span class="co">##  $ eta[5]: num  -0.224 -0.444 -0.3 -0.39 -1.31 ...</span></span>
<span><span class="co">##  $ eta[6]: num  -0.2575 -0.511 -0.5113 -0.7201 0.0883 ...</span></span>
<span><span class="co">##  $ eta[7]: num  0.2236 -0.0579 0.8496 0.0664 1.136 ...</span></span>
<span><span class="co">##  $ eta[8]: num  -0.216 0.422 -0.479 -0.726 -1.365 ...</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## now get a generated quantity, here theta which is a vector of</span></span>
<span><span class="co">## length 8 so becomes a matrix of posterior samples</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">post</span>,<span class="fl">1</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">obj</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">theta</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  num [1:1000, 1:8] 40.606 58.386 4.221 8.714 -0.787 ...</span></span></code></pre>
<p>Likewise, marginal distributions can be explored visually and
compared to the approximate estimate from the conditional mode and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Σ</mi><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math>
(red lines):</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_marginals.html">plot_marginals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<p><img src="SparseNUTS_files/figure-html/marginals-schools-1.png" class="r-plt" alt="" width="700"></p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-monnahan2018" class="csl-entry">
Monnahan, C. C, and Kasper Kristensen. 2018. <span>“No-u-Turn Sampling
for Fast Bayesian Inference in ADMB and TMB: Introducing the Adnuts and
Tmbstan r Packages.”</span> <em>PloS One</em> 13 (5).
</div>
<div id="ref-monnahan2025" class="csl-entry">
Monnahan, C. C., Thorson J. T., K. Kristensen, and B. Carpenter. in
prep. <span>“Leveraging Sparsity to Improve No-u-Turn Sampling
Efficiency for Hierarchical Bayesian Models.”</span> <em>arXiv
Preprint</em>, in prep.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Cole Monnahan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
