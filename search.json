[{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"differences-between-tmb-and-rtmb","dir":"Articles","previous_headings":"","what":"Differences between TMB and RTMB","title":"Sparse NUTS for TMB models","text":"SparseNUTS implements sparse -u-turn sampler (SNUTS) introduced detailed (C. C. Monnahan et al. prep). works TMB models Stan currently way pass use sparse metric. TMB RTMB models can used without user specification, including parallel chains. sample_snuts function detect used internally adjust accordingly. user wants use models packages session one needs unloaded, e.g., ('TMB' %% .packages()) detach(package:TMB), package loaded. RTMB model uses external functions data sets must passed via list globals argument available rebuild ‘obj’ parallel R sessions. Optionally, model_name can specified call, otherwise model labeled “RTMB” output. TMB models require globals input model name pulled DLL name, can overridden desired.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"comparison-to-tmbstan","dir":"Articles","previous_headings":"","what":"Comparison to tmbstan","title":"Sparse NUTS for TMB models","text":"related package ‘tmbstan’ (C. C. Monnahan Kristensen 2018) also allows users link TMB models Stan algorithms. ‘tmbstan’ links package ‘rstan’, ‘SparseNUTS’ modifies objective gradient functions passes ‘cmdstan’ ‘StanEstimators’ R package interface. models without large correlations scale differences, tmbstan likely faster ‘SparseNUTS’ due lower overhead may better option. Eventually, Stan may add SNUTS functionality interface ‘tmbstan’ developed, case tmbstan may better long term option. TMB users now, SNUTS via SparseNUTS likely best overall package Bayesian inference.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"snuts-for-tmb-models-from-existing-packages-sdmtmb-glmmtmb-etc-","dir":"Articles","previous_headings":"","what":"SNUTS for TMB models from existing packages (sdmTMB, glmmTMB, etc.)","title":"Sparse NUTS for TMB models","text":"SparseNUTS works custom TMB RTMB models developed locally, also come packages. packages return TMB ‘obj’ can passed sample_snuts. instance glmmTMB package can run like :","code":"library(glmmTMB) data(Salamanders) obj <- glmmTMB(count~spp * mined + (1|site), Salamanders, family=\"nbinom2\")$obj fit <- sample_snuts(obj)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"basic-usage","dir":"Articles","previous_headings":"","what":"Basic usage","title":"Sparse NUTS for TMB models","text":"recommended usage TMB users let sample_snuts function automatically detect metric use length warmup period, especially pilot runs model development. demonstrate basic usage using simple RTMB version eight schools model examined extensively Bayesian literature. first step build TMB object ‘obj’ incorporates priors Jacobians parameter transformations. Note R function returns negative un-normalized log-posterior density.","code":"library(RTMB) dat <- list(y=c(28,  8, -3,  7, -1,  1, 18, 12),             sigma=c(15, 10, 16, 11,  9, 11, 10, 18)) pars <- list(mu=0, logtau=0, eta=rep(1,8)) f <- function(pars){   getAll(dat, pars)   theta <- mu + exp(logtau) * eta;   lp <- sum(dnorm(eta, 0,1, log=TRUE))+ # prior     sum(dnorm(y,theta,sigma,log=TRUE))+ #likelihood     logtau                          # jacobian   REPORT(theta)   return(-lp) } obj <- MakeADFun(func=f, parameters=pars,                  random=\"eta\", silent=TRUE)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"posterior-sampling-with-snuts","dir":"Articles","previous_headings":"Basic usage","what":"Posterior sampling with SNUTS","title":"Sparse NUTS for TMB models","text":"common task draw samples posterior density defined model. done sample_snuts function follows: returned object fit (object ‘adfit’ S3 class) contains posterior samples relevant information Bayesian analysis. ‘diag’ (diagonal) metric selected short warmup period 150 iterations used, mass matrix adaptation Stan disabled. See details mass matrix adaptation within Stan. Notice optimization done calling sample_snuts. model already optimized, can skip setting skip_optimization=TRUE, even pass QQ Σ=Q−1\\Sigma=Q^{-1} via arguments Q Qinv bypass step save run time. may also required model optimization routine internal sample_snuts insufficient. case, user optimize prior SNUTS sampling. returned fitted object contains slot called mle (maximum likelihood estimates) conditional mode (‘est’), marginal standard errors ‘se’, joint correlation matrix (‘cor’), sparse precision matrix QQ.","code":"fit <- sample_snuts(obj, refresh=0, seed=1,                     model_name = 'schools',                     cores=1, chains=1,                     globals=list(dat=dat)) #> Optimizing... #> Getting Q... #> Inverting Q... #> Q is 62.22% zeroes, with condition factor=56 (min=0.044, max=2.5) #> Rebuilding RTMB obj without random effects... #> diag metric selected b/c of low correlations (max=0.2927) #> log-posterior at inits=-34.661; at conditional mode=-34.661 #> Starting MCMC sampling... #>  #>  #> Gradient evaluation took 9.1e-05 seconds #> 1000 transitions using 10 leapfrog steps per transition would take 0.91 seconds. #> Adjust your expectations accordingly! #>  #>  #>  #>  Elapsed Time: 0.111 seconds (Warm-up) #>                0.609 seconds (Sampling) #>                0.72 seconds (Total) #>  #>  #>  #> Model 'schools' has 10 pars, and was fit using NUTS with a 'diag' metric #> 1 chain(s) of 1150 total iterations (150 warmup) were used #> Average run time per chain was 0.72 seconds  #> Minimum ESS=266 (26.6%), and maximum Rhat=1.003 #> There were 0 divergences after warmup str(fit$mle) #> List of 5 #>  $ nopar: int 10 #>  $ est  : Named num [1:10] 7.92441 1.8414 0.47811 0.00341 -0.2329 ... #>   ..- attr(*, \"names\")= chr [1:10] \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ... #>  $ se   : Named num [1:10] 4.725 0.732 0.959 0.872 0.945 ... #>   ..- attr(*, \"names\")= chr [1:10] \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ... #>  $ cor  : num [1:10, 1:10] 1 0.0558 -0.1031 -0.2443 -0.114 ... #>   ..- attr(*, \"dimnames\")=List of 2 #>   .. ..$ : chr [1:10] \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ... #>   .. ..$ : chr [1:10] \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ... #>  $ Q    :Formal class 'dsCMatrix' [package \"Matrix\"] with 7 slots #>   .. ..@ i       : int [1:27] 0 1 2 3 4 5 6 7 8 9 ... #>   .. ..@ p       : int [1:11] 0 10 19 20 21 22 23 24 25 26 ... #>   .. ..@ Dim     : int [1:2] 10 10 #>   .. ..@ Dimnames:List of 2 #>   .. .. ..$ : chr [1:10] \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ... #>   .. .. ..$ : chr [1:10] \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ... #>   .. ..@ x       : num [1:27] 0.0603 -0.0144 0.028 0.0631 0.0246 ... #>   .. ..@ uplo    : chr \"L\" #>   .. ..@ factors :List of 1 #>   .. .. ..$ SPdCholesky:Formal class 'dCHMsuper' [package \"Matrix\"] with 10 slots #>   .. .. .. .. ..@ x       : num [1:100] 1.06 0 0 0 0 ... #>   .. .. .. .. ..@ super   : int [1:2] 0 10 #>   .. .. .. .. ..@ pi      : int [1:2] 0 10 #>   .. .. .. .. ..@ px      : int [1:2] 0 100 #>   .. .. .. .. ..@ s       : int [1:10] 0 1 2 3 4 5 6 7 8 9 #>   .. .. .. .. ..@ type    : int [1:6] 2 1 1 1 1 1 #>   .. .. .. .. ..@ colcount: int [1:10] 3 3 3 3 3 3 4 3 2 1 #>   .. .. .. .. ..@ perm    : int [1:10] 9 8 7 6 5 4 0 2 3 1 #>   .. .. .. .. ..@ Dim     : int [1:2] 10 10 #>   .. .. .. .. ..@ Dimnames:List of 2 #>   .. .. .. .. .. ..$ : chr [1:10] \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ... #>   .. .. .. .. .. ..$ : chr [1:10] \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ..."},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"diagnostics","dir":"Articles","previous_headings":"Basic usage","what":"Diagnostics","title":"Sparse NUTS for TMB models","text":"common MCMC diagnostics potential scale reduction (Rhat) minimum ESS, well NUTS divergences (see diagnostics section rstan manual), printed console default can accessed depth via monitor slot: specialized pairs plotting function available (formally called pairs_admb) examine pair-wise behavior posteriors. can useful help diagnose particularly slow mixing parameters. function also displays conditional mode (point) 95% bivariate confidence region (ellipses) calculated approximate covariance matrix Σ=Q−1\\Sigma=Q^{-1}. parameters show can specified either vie character vector like pars=c('mu', 'logtau', 'eta[1]') integer vector like pars=1:3, using latter parameters can ordered slowest mixing (‘slow’), fastest mixing (‘fast’) largest discrepancies approximate marginal variance QQ posterior samples (‘mismatch’). NUTS divergences shown green points. See help information ?pairs.adfit.  cases useful diagnose NUTS behavior examining “sampler parameters”, contain information individual NUTS trajectories.  ShinyStan tool also available provides convenient, interactive way check diagnostics via function launch_shinytmb(), also explore estimates important quantities. valuable tool workflow ‘SparseNUTS’.","code":"print(fit) #> Model 'schools' has 10 pars, and was fit using NUTS with a 'diag' metric #> 1 chain(s) of 1150 total iterations (150 warmup) were used #> Average run time per chain was 0.72 seconds  #> Minimum ESS=266 (26.6%), and maximum Rhat=1.003 #> There were 0 divergences after warmup  fit$monitor |> str() #> 'data.frame':    11 obs. of  23 variables: #>  $ variable  : chr  \"mu\" \"logtau\" \"eta[1]\" \"eta[2]\" ... #>  $ mean      : num  7.8963 1.3284 0.3436 0.0114 -0.1834 ... #>  $ se_mean   : num  0.1765 0.0673 0.0269 0.0249 0.0264 ... #>  $ sd        : num  4.767 1.161 0.972 0.834 0.863 ... #>  $ 2.5%      : num  -1.12 -1.5 -1.74 -1.63 -1.86 ... #>  $ 25%       : num  4.805 0.654 -0.352 -0.511 -0.754 ... #>  $ 50%       : num  7.5789 1.6113 0.399 0.0223 -0.1674 ... #>  $ 75%       : num  10.941 2.181 1.017 0.532 0.381 ... #>  $ 97.5%     : num  17.67 2.98 2.16 1.66 1.52 ... #>  $ n_eff     : num  745 309 1355 1163 1063 ... #>  $ Rhat      : num  1 1.001 0.999 1 1 ... #>  $ valid     : num  1 1 1 1 1 1 1 1 1 1 ... #>  $ Q5        : num  0.246 -1.01 -1.286 -1.344 -1.569 ... #>  $ Q50       : num  7.5789 1.6113 0.399 0.0223 -0.1674 ... #>  $ Q95       : num  15.75 2.82 1.85 1.36 1.26 ... #>  $ MCSE_Q2.5 : num  0.5872 0.1836 0.1165 0.0942 0.05 ... #>  $ MCSE_Q25  : num  0.2543 0.108 0.0474 0.0308 0.0362 ... #>  $ MCSE_Q50  : num  0.2329 0.056 0.032 0.0282 0.0347 ... #>  $ MCSE_Q75  : num  0.3126 0.0405 0.0391 0.0354 0.0329 ... #>  $ MCSE_Q97.5: num  0.4675 0.0674 0.1179 0.0931 0.0357 ... #>  $ MCSE_SD   : num  0.1332 0.0476 0.0299 0.0264 0.0242 ... #>  $ Bulk_ESS  : num  745 309 1355 1163 1063 ... #>  $ Tail_ESS  : num  534 502 692 704 603 568 847 660 768 671 ... pairs(fit, order='slow') extract_sampler_params(fit) |> str() #> 'data.frame':    850 obs. of  8 variables: #>  $ chain        : num  1 1 1 1 1 1 1 1 1 1 ... #>  $ iteration    : num  151 152 153 154 155 156 157 158 159 160 ... #>  $ accept_stat__: num  0.901 0.762 0.546 0.896 0.945 ... #>  $ stepsize__   : num  0.492 0.492 0.492 0.492 0.492 ... #>  $ treedepth__  : num  3 3 4 3 3 3 3 2 3 3 ... #>  $ n_leapfrog__ : num  7 7 15 7 7 7 7 3 7 7 ... #>  $ divergent__  : num  0 0 0 0 0 0 0 0 0 0 ... #>  $ energy__     : num  46.7 44.8 43.4 44.3 43.5 ... ## or plot them directly plot_sampler_params(fit)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"bayesian-inference","dir":"Articles","previous_headings":"Basic usage","what":"Bayesian inference","title":"Sparse NUTS for TMB models","text":"checking signs non-convergence results can used inference. Posterior samples parameters can extracted examined R casting fitted object R data.frame. posterior samples can put back TMB object obj$report() function extract desired “generated quantity” Stan terminology. demonstration quantity theta (vector length 8). Likewise, marginal distributions can explored visually compared approximate estimate conditional mode Σ\\Sigma (red lines):","code":"post <- as.data.frame(fit) post |> str() #> 'data.frame':    1000 obs. of  10 variables: #>  $ mu    : num  12.01 9.87 4.4 10.34 4.88 ... #>  $ logtau: num  3.328 3.605 -1.271 -0.259 2.178 ... #>  $ eta[1]: num  1.026 1.319 -0.646 -2.113 -0.642 ... #>  $ eta[2]: num  0.513 -0.215 0.132 0.175 0.961 ... #>  $ eta[3]: num  0.04341 -0.44468 -0.01319 -0.30872 -0.00504 ... #>  $ eta[4]: num  -0.0476 -0.3879 -0.2872 -1.1967 -0.4708 ... #>  $ eta[5]: num  -0.224 -0.444 -0.3 -0.39 -1.31 ... #>  $ eta[6]: num  -0.2575 -0.511 -0.5113 -0.7201 0.0883 ... #>  $ eta[7]: num  0.2236 -0.0579 0.8496 0.0664 1.136 ... #>  $ eta[8]: num  -0.216 0.422 -0.479 -0.726 -1.365 ... ## now get a generated quantity, here theta which is a vector of ## length 8 so becomes a matrix of posterior samples theta <- apply(post,1, \\(x) obj$report(x)$theta) |> t() theta |> str() #>  num [1:1000, 1:8] 40.606 58.386 4.221 8.714 -0.787 ... plot_marginals(fit)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"a-more-complicated-example","dir":"Articles","previous_headings":"","what":"A more complicated example","title":"Sparse NUTS for TMB models","text":"demonstrate basic usage use complicated model. modified ChickWeight random slopes intercepts example RTMB introduction. Modifications include: switching SD parameters log space adding Jacobian, adding broad priors SDs, adding ‘loglik’ vector PSIS-LOO ().","code":"parameters <- list(   mua=0,          ## Mean slope   logsda=0,          ## Std of slopes   mub=0,          ## Mean intercept   logsdb=0,          ## Std of intercepts   logsdeps=1,        ## Residual Std   a=rep(0, 50),   ## Random slope by chick   b=rep(0, 50)    ## Random intercept by chick )  f <- function(parms) {   require(RTMB) # for tmbstan   getAll(ChickWeight, parms, warn=FALSE)   sda <- exp(logsda)   sdb <- exp(logsdb)   sdeps <- exp(logsdeps)   ## Optional (enables extra RTMB features)   weight <- OBS(weight)   predWeight <- a[Chick] * Time + b[Chick]   loglik <- dnorm(weight, predWeight, sd=sdeps, log=TRUE)      # calculate the target density   lp <-   sum(loglik)+ # likelihood     # random effect vectors     sum(dnorm(a, mean=mua, sd=sda, log=TRUE)) +      sum(dnorm(b, mean=mub, sd=sdb, log=TRUE)) +     # broad half-normal priors on SD pars     dnorm(sda, 0, 10, log=TRUE) +      dnorm(sdb, 0, 10, log=TRUE) +      dnorm(sdeps, 0, 10, log=TRUE) +      # jacobian adjustments     logsda + logsdb + logsdeps      # reporting   REPORT(loglik)       # for PSIS-LOO   ADREPORT(predWeight) # delta method   REPORT(predWeight)   # standard report      return(-lp) # negative log-posterior density }  obj <- MakeADFun(f, parameters, random=c(\"a\", \"b\"), silent=TRUE)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"asymptotic-frequentist-approximatation-vs-full-posterior","dir":"Articles","previous_headings":"","what":"Asymptotic (frequentist) approximatation vs full posterior","title":"Sparse NUTS for TMB models","text":"Instead sampling posterior MCMC (SNUTS), can use asymptotic tools TMB get quick approximation parameters, covariances, also uncertainties generated quantities via generalized delta method. See TMB documentation background. Briefly, marginal posterior mode found joint precision matrix QQ determined conditional mode. Σ=Q−1\\Sigma=Q{-1} covariance parameters. First optimize model call TMB’s sdreport function get approximate uncertainties via delta method joint precision matrix QQ.  Now run SNUTS get posterior samples compare .","code":"# optimize opt <- with(obj, nlminb(par, fn, gr)) # get generalized delta method results and Q sdrep <- sdreport(obj, getJointPrecision=TRUE)  # get the generalized delta method estimates of asymptotic # standard errors est <-as.list(sdrep, 'Estimate', report=TRUE)$predWeight se <- as.list(sdrep, 'Std. Error', report=TRUE)$predWeight  Q <- sdrep$jointPrecision # can get the joint covariance and correlation like this Sigma <- as.matrix(solve(Q)) cor <- cov2cor(Sigma) plot_Q(Q=Q) # some very strong negative correlations so I expect a dense or # sparse metric to be selected with SNUTS. Because I optimized # above can skip that mcmc <- sample_snuts(obj, chains=1, init='random', seed=1234,                      refresh=0, skip_optimization=TRUE,                      Q=Q, Qinv=Sigma) #> Q is 92.58% zeroes, with condition factor=74028 (min=0.014, max=1018.9) #> Rebuilding RTMB obj without random effects... #> dense metric selected b/c faster than sparse and high correlation (max=0.81) #> log-posterior at inits=-2627.037; at conditional mode=-2574.481 #> Starting MCMC sampling... #>  #>  #> Gradient evaluation took 0.000181 seconds #> 1000 transitions using 10 leapfrog steps per transition would take 1.81 seconds. #> Adjust your expectations accordingly! #>  #>  #>  #>  Elapsed Time: 0.352 seconds (Warm-up) #>                1.651 seconds (Sampling) #>                2.003 seconds (Total) #>  #>  #>  #> Model 'RTMB' has 105 pars, and was fit using NUTS with a 'dense' metric #> 1 chain(s) of 1150 total iterations (150 warmup) were used #> Average run time per chain was 2 seconds  #> Minimum ESS=271 (27.1%), and maximum Rhat=1.019 #> There were 0 divergences after warmup post <- as.data.frame(mcmc)  plot_uncertainties(mcmc) ## get posterior of generated quantities predWeight <- apply(post,1, \\(x) obj$report(x)$predWeight) |>    t() predWeight |> str() #>  num [1:1000, 1:578] 28.1 29.3 23.5 24.8 26.7 ...  # compare asymptotic vs posterior intervals of first few chicks par(mfrow=c(2,3)) for(ii in 1:6){   y <- predWeight[,ii]   x <- seq(min(y), max(y), len=200)   y2 <- dnorm(x,est[ii], se[ii])   hist(y, freq=FALSE, ylim=c(0,max(y2)))   lines(x, y2, col=2, lwd=2) } dev.off() #> null device  #>           1"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"simulation-of-parameters-and-data","dir":"Articles","previous_headings":"","what":"Simulation of parameters and data","title":"Sparse NUTS for TMB models","text":"Simulation data can done directly R. Specialized simulation functionality exists TMB, lesser degree RTMB, keep simple demonstration purposes. data parameters can simulated explore .","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"prior-and-posterior-predictive-distributions","dir":"Articles","previous_headings":"Simulation of parameters and data","what":"Prior and posterior predictive distributions","title":"Sparse NUTS for TMB models","text":"Prior predictive sampling done way shown .","code":"# simulation of data sets can be done manually in R. For instance # to get posterior predictive I loop through each posterior # sample and draw new data. set.seed(351231) simdat <- apply(post,1, \\(x){    yhat <- obj$report(x)$predWeight    ysim <- rnorm(n=length(yhat), yhat, sd=exp(x['logsdeps'])) }) |> t() boxplot(simdat[,1:24], main='Posterior predictive') points(ChickWeight$weight[1:24], col=2, cex=2, pch=16)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"joint-precision-sampling","dir":"Articles","previous_headings":"Simulation of parameters and data","what":"Joint precision sampling","title":"Sparse NUTS for TMB models","text":"Samples can drawn QQ, assuming multivariate normality, follows: samples put back report function get distribution generated quantity, instance.","code":"# likewise I can simulate draws from Q to get approximate samples postQ <- mvtnorm::rmvnorm(1000, mean=mcmc$mle$est, sigma=Sigma)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"model-selection-with-psis-loo","dir":"Articles","previous_headings":"","what":"Model selection with PSIS-LOO","title":"Sparse NUTS for TMB models","text":"PSIS-LOO recommended way compare predictive performance Bayesian models. use compare simplified Chicks model using map argument turn estimation random intercepts (‘b’). requires vector log-likelihood values available posterior draw. facilitate via REPORT(loglik) call .","code":"library(loo) #> This is loo version 2.8.0 #> - Online documentation and vignettes at mc-stan.org/loo #> - As of v2.0.0 loo defaults to 1 core but we recommend using as many as possible. Use the 'cores' argument or set options(mc.cores = NUM_CORES) for an entire session. options(mc.cores=parallel::detectCores()) loglik <- apply(post,1, \\(x) obj$report(x)$loglik) |>    t()  loo1 <- loo(loglik, cores=4) #> Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details. print(loo1) #>  #> Computed from 1000 by 578 log-likelihood matrix. #>  #>          Estimate   SE #> elpd_loo  -2351.8 19.9 #> p_loo        88.5  6.9 #> looic      4703.6 39.7 #> ------ #> MCSE of elpd_loo is NA. #> MCSE and ESS estimates assume independent draws (r_eff=1). #>  #> Pareto k diagnostic values: #>                           Count Pct.    Min. ESS #> (-Inf, 0.67]   (good)     572   99.0%   103      #>    (0.67, 1]   (bad)        6    1.0%   <NA>     #>     (1, Inf)   (very bad)   0    0.0%   <NA>     #> See help('pareto-k-diagnostic') for details. plot(loo1) # I can compare that to a simpler model which doesn't have # random effects on the slope obj2 <- MakeADFun(f, parameters, random=c(\"a\"), silent=TRUE,                   map=list(b=factor(rep(NA, length(parameters$b))),                             logsdb=factor(NA),                            mub=factor(NA))) mcmc2 <- sample_snuts(obj2, chains=1, seed=1215, refresh=0) #> Optimizing... #> Getting Q... #> Inverting Q... #> Q is 88.9% zeroes, with condition factor=8423 (min=0.128, max=1080.5) #> Rebuilding RTMB obj without random effects... #> diag metric selected b/c of low correlations (max=0.1386) #> log-posterior at inits=-2745.519; at conditional mode=-2745.519 #> Starting MCMC sampling... #>  #>  #> Gradient evaluation took 0.000105 seconds #> 1000 transitions using 10 leapfrog steps per transition would take 1.05 seconds. #> Adjust your expectations accordingly! #>  #>  #>  #>  Elapsed Time: 0.177 seconds (Warm-up) #>                0.941 seconds (Sampling) #>                1.118 seconds (Total) #>  #>  #>  #> Model 'RTMB' has 53 pars, and was fit using NUTS with a 'diag' metric #> 1 chain(s) of 1150 total iterations (150 warmup) were used #> Average run time per chain was 1.12 seconds  #> Minimum ESS=367 (36.7%), and maximum Rhat=1.01 #> There were 0 divergences after warmup post2 <- as.data.frame(mcmc2) loglik2 <- apply(post2,1, \\(x) obj2$report(x)$loglik) |>    t() loo2 <- loo(loglik2, cores=4) #> Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details. print(loo2) #>  #> Computed from 1000 by 578 log-likelihood matrix. #>  #>          Estimate   SE #> elpd_loo  -2613.1 14.4 #> p_loo        31.8  3.0 #> looic      5226.2 28.9 #> ------ #> MCSE of elpd_loo is NA. #> MCSE and ESS estimates assume independent draws (r_eff=1). #>  #> Pareto k diagnostic values: #>                           Count Pct.    Min. ESS #> (-Inf, 0.67]   (good)     577   99.8%   195      #>    (0.67, 1]   (bad)        1    0.2%   <NA>     #>     (1, Inf)   (very bad)   0    0.0%   <NA>     #> See help('pareto-k-diagnostic') for details. loo_compare(loo1, loo2) #>        elpd_diff se_diff #> model1    0.0       0.0  #> model2 -261.3      19.3"},{"path":[]},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"adaptation-of-stan-diagonal-mass-matrix","dir":"Articles","previous_headings":"Advanced features","what":"Adaptation of Stan diagonal mass matrix","title":"Sparse NUTS for TMB models","text":"estimate QQ well approximate posterior surface, may advantageous adapt diagonal mass matrix account changes scale. can controlled via adapt_stan_metric argument. argument automatically set FALSE using metric ‘stan’ ‘unit’ since metrics theory already descale posterior. can overridden setting equal TRUE run three versions model compare NUTS stepsize. model version without adaptation uses shorter warmup period  apparent first warmup phase model Stan defaults (‘adapted’ plot) large adjustment stepsize corresponds long trajectory lengths thus increased computational time. descaled using QQ adaptation nothing (‘descaled + adapted’), short warmup period can used SNUTS (‘descaled + adapted’) case, often default warmup short adaptation disabled SNUTS. cases longer warmup mass matrix adaptation make difference, see example ‘wildf’ model C. C. Monnahan et al. (prep).","code":"library(ggplot2)  adapted1 <- sample_snuts(obj, chains=1, seed=1234, refresh=0,                         skip_optimization=TRUE, Q=Q, Qinv=Sigma,                         metric='auto', adapt_stan_metric = TRUE) #> Q is 92.58% zeroes, with condition factor=74028 (min=0.014, max=1018.9) #> Rebuilding RTMB obj without random effects... #> dense metric selected b/c faster than sparse and high correlation (max=0.81) #> log-posterior at inits=-2574.481; at conditional mode=-2574.481 #> Starting MCMC sampling... #>  #>  #> Gradient evaluation took 0.000187 seconds #> 1000 transitions using 10 leapfrog steps per transition would take 1.87 seconds. #> Adjust your expectations accordingly! #>  #>  #>  #>  Elapsed Time: 2.497 seconds (Warm-up) #>                2.44 seconds (Sampling) #>                4.937 seconds (Total) #>  #>  #>  #> Model 'RTMB' has 105 pars, and was fit using NUTS with a 'dense' metric #> 1 chain(s) of 2000 total iterations (1000 warmup) were used #> Average run time per chain was 4.94 seconds  #> Minimum ESS=282 (28.2%), and maximum Rhat=1.016 #> Warning in cbind(chain = i, iteration = its, x[[i]][ind, , drop = FALSE]): #> number of rows of result is not a multiple of vector length (arg 1) #> There were 0 divergences after warmup adapted2 <- sample_snuts(obj, chains=1, seed=1234, refresh=0,                      skip_optimization=TRUE, Q=Q, Qinv=Sigma,                      metric='stan', adapt_stan_metric = TRUE) #> Rebuilding RTMB obj without random effects... #> log-posterior at inits=-2574.399 #> Starting MCMC sampling... #>  #>  #> Gradient evaluation took 0.000113 seconds #> 1000 transitions using 10 leapfrog steps per transition would take 1.13 seconds. #> Adjust your expectations accordingly! #>  #>  #>  #>  Elapsed Time: 12.085 seconds (Warm-up) #>                4.396 seconds (Sampling) #>                16.481 seconds (Total) #>  #>  #>  #> Model 'RTMB' has 105 pars, and was fit using NUTS with a 'stan' metric #> 1 chain(s) of 2000 total iterations (1000 warmup) were used #> Average run time per chain was 16.48 seconds  #> Minimum ESS=346 (34.6%), and maximum Rhat=1.016 #> Warning in cbind(chain = i, iteration = its, x[[i]][ind, , drop = FALSE]): #> number of rows of result is not a multiple of vector length (arg 1) #> There were 0 divergences after warmup sp1 <- extract_sampler_params(mcmc, inc_warmup = TRUE) |>   subset(iteration <= 1050) |>    cbind(type='descaled + not adapted') sp2 <- extract_sampler_params(adapted1, inc_warmup = TRUE) |>   subset(iteration <= 1050) |>    cbind(type='descaled + adapted') sp3 <- extract_sampler_params(adapted2, inc_warmup = TRUE) |>   subset(iteration <= 1050) |>    cbind(type='adapted') sp <- rbind(sp1, sp2, sp3) ggplot(sp, aes(x=iteration, y=stepsize__, color=type)) + geom_line() +   scale_y_log10() + theme_bw() + theme(legend.position = 'top') +   labs(color=NULL, x='warmup')"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"embedded-laplace-approximation-snuts","dir":"Articles","previous_headings":"Advanced features","what":"Embedded Laplace approximation SNUTS","title":"Sparse NUTS for TMB models","text":"approach uses NUTS (SNUTS) sample marginal posterior using Laplace approximation integrate random effects. first explored (C. C. Monnahan Kristensen 2018) later detail (Margossian et al. 2020) called ‘embedded Laplace approximation’. (C. C. Monnahan et al. prep) applied much larger set models found mixed results. trivial try SNUTS simply declaring laplace=TRUE. can see 5 model parameters (fixed effects), diagonal metric chosen due minimal correlations among parameters. ELA typically take longer run, higher minESS best compare efficiency (minESS per time) . Exploring ELA good opportunity show SNUTS can fail. demonstrate notoriously difficult ‘funnel’ model hierarchical model without data. model strongly varying curvature thus well-approximated QQ SNUTS mixes poorly. turning ELA, mixes fine recovers ","code":"ela <- sample_snuts(obj, chains=1, laplace=TRUE, refresh=0) #> Optimizing... #> Getting M for fixed effects... #> Qinv is 0% zeroes, with condition factor=3107 (min=0.001, max=3.3) #> diag metric selected b/c low correlations (max=0.1458) #> log-posterior at inits=-2451.942; at conditional mode=-2451.942 #> Starting MCMC sampling... #>  #>  #> Gradient evaluation took 0.000829 seconds #> 1000 transitions using 10 leapfrog steps per transition would take 8.29 seconds. #> Adjust your expectations accordingly! #>  #>  #>  #>  Elapsed Time: 1.235 seconds (Warm-up) #>                7.187 seconds (Sampling) #>                8.422 seconds (Total) #>  #>  #>  #> Model 'RTMB' has 5 pars, and was fit using NUTS with a 'diag' metric #> 1 chain(s) of 1150 total iterations (150 warmup) were used #> Average run time per chain was 8.42 seconds  #> Minimum ESS=572 (57.2%), and maximum Rhat=1.004 #> There were 0 divergences after warmup # Funnel example ported to RTMB from # https://mc-stan.org/docs/cmdstan-guide/diagnose_utility.html#running-the-diagnose-command ## the (negative) posterior density as a function in R f <- function(pars){   getAll(pars)   lp <- dnorm(y, 0, 3, log=TRUE) + # prior     sum(dnorm(x, 0, exp(y/2), log=TRUE)) # likelihood   return(-lp) # TMB expects negative log posterior } obj <- RTMB::MakeADFun(f, list(y=-1.12, x=rep(0,9)), random='x', silent=TRUE)  ### Now SNUTS fit <- sample_snuts(obj, seed=1213, refresh=0, init='random') #> Optimizing... #> Getting Q... #> Inverting Q... #> Q is 100% zeroes, with condition factor=9 (min=0.111, max=1) #> Rebuilding RTMB obj without random effects... #> diag metric selected b/c of low correlations (max=0) #> log-posterior at inits=-237.116; at conditional mode=-10.288 #> Starting MCMC sampling... #> Preparing parallel workspace... #> Chain 1: Gradient evaluation took 0.000176 seconds #> Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.76 seconds. #> Chain 1: Adjust your expectations accordingly! #> Chain 4: Gradient evaluation took 0.000194 seconds #> Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 1.94 seconds. #> Chain 4: Adjust your expectations accordingly! #> Chain 3: Gradient evaluation took 0.00022 seconds #> Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 2.2 seconds. #> Chain 3: Adjust your expectations accordingly! #> Chain 2: Gradient evaluation took 0.000183 seconds #> Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 1.83 seconds. #> Chain 2: Adjust your expectations accordingly! #> Chain 3:  Elapsed Time: 2.295 seconds (Warm-up) #> Chain 3:                10.243 seconds (Sampling) #> Chain 3:                12.538 seconds (Total) #> Chain 2:  Elapsed Time: 3.871 seconds (Warm-up) #> Chain 2:                13.955 seconds (Sampling) #> Chain 2:                17.826 seconds (Total) #> Chain 1:  Elapsed Time: 1.697 seconds (Warm-up) #> Chain 1:                17.775 seconds (Sampling) #> Chain 1:                19.472 seconds (Total) #> Chain 4:  Elapsed Time: 1.421 seconds (Warm-up) #> Chain 4:                18.427 seconds (Sampling) #> Chain 4:                19.848 seconds (Total) #> 8 of 4000 (0.2%) sampling iterations ended with a divergence. #> These divergent transitions indicate that HMC is not fully able to explore the posterior distribution. #> Try increasing adapt_delta closer to 1. #> If this doesn't remove all divergences, try to reparameterize the model. #> 4 of 4 chains had an E-BFMI below the nominal threshold of 0.3 which suggests that HMC may have trouble exploring the target distribution. #> If possible, try to reparameterize the model. #>  #>  #> Model 'RTMB' has 10 pars, and was fit using NUTS with a 'diag' metric #> 4 chain(s) of 1150 total iterations (150 warmup) were used #> Average run time per chain was 17.42 seconds  #> Minimum ESS=53 (1.32%), and maximum Rhat=1.094 #> !! Warning: Signs of non-convergence found. Do not use for inference !! #> There were 8 divergences after warmup pairs(fit, pars=1:2) # hasn't recovered the prior b/c it's not converged, particularly # for small y values post <- as.data.frame(fit) hist(post$y, freq=FALSE, xlim=c(-10,10)) lines(x<-seq(-10,10, len=200), dnorm(x,0,3)) abline(v=fit$mle$est[1], col=2, lwd=2) # Now turn on ELA and it easily recovers the prior on y fit.ela <- sample_snuts(obj, laplace=TRUE, refresh=0, init='random', seed=12312) #> Optimizing... #> Getting M for fixed effects... #> diag metric selected b/c only 1 parameter #> log-posterior at inits=-2.681; at conditional mode=-2.018 #> Starting MCMC sampling... #> Preparing parallel workspace... #> Chain 1: Gradient evaluation took 0.067631 seconds #> Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 676.31 seconds. #> Chain 1: Adjust your expectations accordingly! #> Chain 4: Gradient evaluation took 0.035142 seconds #> Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 351.42 seconds. #> Chain 4: Adjust your expectations accordingly! #> Chain 2: Gradient evaluation took 0.039829 seconds #> Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 398.29 seconds. #> Chain 2: Adjust your expectations accordingly! #> Chain 3: Gradient evaluation took 0.037843 seconds #> Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 378.43 seconds. #> Chain 3: Adjust your expectations accordingly! #> Chain 1:  Elapsed Time: 0.594 seconds (Warm-up) #> Chain 1:                3.687 seconds (Sampling) #> Chain 1:                4.281 seconds (Total) #> Chain 4:  Elapsed Time: 0.736 seconds (Warm-up) #> Chain 4:                3.498 seconds (Sampling) #> Chain 4:                4.234 seconds (Total) #> Chain 2:  Elapsed Time: 0.652 seconds (Warm-up) #> Chain 2:                3.704 seconds (Sampling) #> Chain 2:                4.356 seconds (Total) #> Chain 3:  Elapsed Time: 0.686 seconds (Warm-up) #> Chain 3:                3.513 seconds (Sampling) #> Chain 3:                4.199 seconds (Total) #>  #>  #> Model 'RTMB' has 1 pars, and was fit using NUTS with a 'diag' metric #> 4 chain(s) of 1150 total iterations (150 warmup) were used #> Average run time per chain was 4.27 seconds  #> Minimum ESS=1415 (35.38%), and maximum Rhat=1.005 #> There were 0 divergences after warmup # you just get the prior back b/c the Laplace approximation is # accurate pairs(fit.ela) post.ela <- as.data.frame(fit.ela) hist(post.ela$y, freq=FALSE, breaks=30) lines(x<-seq(-10,10, len=200), dnorm(x,0,3))"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"linking-to-other-stan-algorithms-via-stanestimators","dir":"Articles","previous_headings":"Advanced features","what":"Linking to other Stan algorithms via StanEstimators","title":"Sparse NUTS for TMB models","text":"sample_snuts links StanEstimators::stan_sample function NUTS sampling. However, package provides algorithms given model may interest users. focus Pathfinder algorithm RTMB model.","code":"# Construct a joint model (no random effects) obj2 <- MakeADFun(func=obj$env$data, parameters=obj$env$parList(),                    map=obj$env$map, random=NULL, silent=TRUE) # TMB does negative log densities so convert to form used by Stan fn <- function(x) -obj2$fn(x) grad_fun <- function(x) -obj2$gr(x) pf <- StanEstimators::stan_pathfinder(fn=fn, grad_fun=grad_fun, refresh=100,                       par_inits = obj$env$last.par.best) #>  #> Path [1] :Initial log joint density = -10.287998 #> Path [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  #>               2       8.084e+01      3.600e+01   4.441e-15    1.000e+00  1.000e+00        62 -4.131e+01 -7.402e+19                   #> Path [1] :Best Iter: [1] ELBO (-41.305109) evaluations: (62) #> Path [2] :Initial log joint density = -10.287998 #> Path [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  #>               2       8.084e+01      3.600e+01   4.441e-15    1.000e+00  1.000e+00        62 -4.923e+01 -2.874e+20                   #> Path [2] :Best Iter: [1] ELBO (-49.230004) evaluations: (62) #> Path [3] :Initial log joint density = -10.287998 #> Path [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  #>               2       8.084e+01      3.600e+01   4.441e-15    1.000e+00  1.000e+00        62 -4.575e+01 -1.548e+20                   #> Path [3] :Best Iter: [1] ELBO (-45.753631) evaluations: (62) #> Path [4] :Initial log joint density = -10.287998 #> Path [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  #>               2       8.084e+01      3.600e+01   4.441e-15    1.000e+00  1.000e+00        62 -3.875e+01 -2.349e+21                   #> Path [4] :Best Iter: [1] ELBO (-38.747776) evaluations: (62) #> Pareto k value (1.5) is greater than 0.7. Importance resampling was not able to improve the approximation, which may indicate that the approximation itself is poor."},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SNUTS-for-TMB-models.html","id":"linking-to-other-bayesian-tools","dir":"Articles","previous_headings":"Advanced features","what":"Linking to other Bayesian tools","title":"Sparse NUTS for TMB models","text":"straightforward pass SparseNUTS output Bayesian R packages. demonstrate bayesplot.","code":"library(bayesplot) #> This is bayesplot version 1.14.0 #> - Online documentation and vignettes at mc-stan.org/bayesplot #> - bayesplot theme set to bayesplot::theme_default() #>    * Does _not_ affect other ggplot2 plots #>    * See ?bayesplot_theme_set for details on theme setting library(tidyr) library(dplyr) #>  #> Attaching package: 'dplyr' #> The following objects are masked from 'package:stats': #>  #>     filter, lag #> The following objects are masked from 'package:base': #>  #>     intersect, setdiff, setequal, union post <- as.data.frame(mcmc) pars <- mcmc$par_names[1:6] mcmc_areas(post, pars=pars) mcmc_trace(post, pars=pars) color_scheme_set(\"red\") np <- extract_sampler_params(fit) %>%   pivot_longer(-c(chain, iteration), names_to='Parameter', values_to='Value') %>%   select(Iteration=iteration, Parameter, Value, Chain=chain) %>%   mutate(Parameter=factor(Parameter),          Iteration=as.integer(Iteration),          Chain=as.integer(Chain)) %>% as.data.frame() mcmc_nuts_energy(np) + ggtitle(\"NUTS Energy Diagnostic\") + theme_minimal() #> `stat_bin()` using `bins = 30`. Pick better value `binwidth`. #> `stat_bin()` using `bins = 30`. Pick better value `binwidth`. # finally, posterior predictive for first 24 observations ppc_intervals(y=ChickWeight$weight[1:24], yrep=simdat[,1:24]) #> Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0. #> ℹ Please use `linewidth` instead. #> ℹ The deprecated feature was likely used in the bayesplot package. #>   Please report the issue at <https://github.com/stan-dev/bayesplot/issues/>. #> This warning is displayed once every 8 hours. #> Call `lifecycle::last_lifecycle_warnings()` to see where this warning was #> generated."},{"path":[]},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/articles/SparseNUTS.html","id":"summary","dir":"Articles","previous_headings":"","what":"Summary","title":"Sparse no-U-turn sampling for TMB and RTMB models","text":"SparseNUTS provides interface performing Bayesian analyses using -U-turn (NUTS) MCMC algorithm (Hoffman Gelman 2014) TMB (Kristensen et al. 2016) RTMB models. closely related adnuts package provides functionality ADMB (Fournier et al. 2012) models. TMB models NUTS algorithm Stan software (Carpenter et al. 2017) linked StanEstimators R package. SparseNUTS implements sparse NUTS (SNUTS) algorithm (Monnahan et al. prep) decorrelating descaling posterior distribution prior passing Stan. models high correlations sparse precision matrices, SNUTS can substantially improve sampling efficiency. Importantly, works smiliarly TMB RTMB models, can run models existing packages built either platforms (e.g., glmmTMB). package originally developed inside adnuts package split late 2025 separate package TMB ADMB models. tmbstan package also provides interface Stan software, lacks ability decorrelate target distribution prior sampling. SparseNUTS provides flexible options related mass matrix. Basic usage TMB RTMB object obj shown follows, depth article website.","code":"fit <- sample_snuts(obj) print(fit) plot(fit) pairs(fit, order='slow') post <- as.data.frame(fit) launch_shinytmb(fit)"},{"path":[]},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"First Last. Author, maintainer.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"Last F (2025). SparseNUTS: Sparse -U-Turn MCMC Sampling 'Template Model Builder'. R package version 0.0.0.9000, https://Cole-Monnahan-NOAA.github.io/SparseNUTS.","code":"@Manual{,   title = {SparseNUTS: Sparse No-U-Turn MCMC Sampling for 'Template Model Builder'},   author = {First Last},   year = {2025},   note = {R package version 0.0.0.9000},   url = {https://Cole-Monnahan-NOAA.github.io/SparseNUTS}, }"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/index.html","id":"sparsenuts","dir":"","previous_headings":"","what":"Sparse No-U-Turn MCMC Sampling for Template Model Builder","title":"Sparse No-U-Turn MCMC Sampling for Template Model Builder","text":"Sparse -U-turn sampling TMB RTMB models","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/as.data.frame.snutsfit.html","id":null,"dir":"Reference","previous_headings":"","what":"Convert object of class snutsfit to data.frame. Calls extract_samples — as.data.frame.snutsfit","title":"Convert object of class snutsfit to data.frame. Calls extract_samples — as.data.frame.snutsfit","text":"Convert object class snutsfit data.frame. Calls extract_samples","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/as.data.frame.snutsfit.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Convert object of class snutsfit to data.frame. Calls extract_samples — as.data.frame.snutsfit","text":"","code":"# S3 method for class 'snutsfit' as.data.frame(x, row.names = NULL, optional = FALSE, ...)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/as.data.frame.snutsfit.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Convert object of class snutsfit to data.frame. Calls extract_samples — as.data.frame.snutsfit","text":"x Fitted object sample_rwm row.names Ignored optional Ignored ... Ignored","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/as.data.frame.snutsfit.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Convert object of class snutsfit to data.frame. Calls extract_samples — as.data.frame.snutsfit","text":"data frame parameters columns samples rows.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/as.data.frame.snutsfit.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Convert object of class snutsfit to data.frame. Calls extract_samples — as.data.frame.snutsfit","text":"calls default settings extract_samples, warmup samples column log-posterior (lp__). Use function directly finer control.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/as.tmbfit.html","id":null,"dir":"Reference","previous_headings":"","what":"Construtor for tmbfit objects — as.tmbfit","title":"Construtor for tmbfit objects — as.tmbfit","text":"Construtor tmbfit objects","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/as.tmbfit.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Construtor for tmbfit objects — as.tmbfit","text":"","code":"as.tmbfit(x, parnames, mle, invf, metric, model = \"anonymous\")"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/as.tmbfit.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Construtor for tmbfit objects — as.tmbfit","text":"x fitted MCMC object parnames character vector unique par names mle list MLE parameters invf inverse function parameters metric metric used model character giving model name","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/benchmark_metrics.html","id":null,"dir":"Reference","previous_headings":"","what":"Calculate gradient timings on a model for different metrics — benchmark_metrics","title":"Calculate gradient timings on a model for different metrics — benchmark_metrics","text":"Calculate gradient timings model different metrics","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/benchmark_metrics.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Calculate gradient timings on a model for different metrics — benchmark_metrics","text":"","code":"benchmark_metrics(obj, times = 1000, metrics = NULL, model_name = NULL)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/benchmark_metrics.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Calculate gradient timings on a model for different metrics — benchmark_metrics","text":"obj TMB object times many evaluations metrics character vector different metrics benchmark model_name optional character name model, NULL pull DLL name","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/benchmark_metrics.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Calculate gradient timings on a model for different metrics — benchmark_metrics","text":"data.frame containing median gradient timing (time), percent sparsity \\(Q\\) dimension model (npar).","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-check_console_printing.html","id":null,"dir":"Reference","previous_headings":"","what":"Check if the session is interactive or Rstudio which has implications for parallel output — .check_console_printing","title":"Check if the session is interactive or Rstudio which has implications for parallel output — .check_console_printing","text":"Check session interactive Rstudio implications parallel output","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-check_console_printing.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Check if the session is interactive or Rstudio which has implications for parallel output — .check_console_printing","text":"","code":".check_console_printing(parallel)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-check_console_printing.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Check if the session is interactive or Rstudio which has implications for parallel output — .check_console_printing","text":"parallel Boolean whether chain executed parallel mode .","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-check_console_printing.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Check if the session is interactive or Rstudio which has implications for parallel output — .check_console_printing","text":"Boolean whether output printed console progressively, saved file printed end.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-check_console_printing.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Check if the session is interactive or Rstudio which has implications for parallel output — .check_console_printing","text":"using RStudio RGui, parallel output show console. workaround captured cluster file read printed.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_Q.html","id":null,"dir":"Reference","previous_headings":"","what":"Get the joint precision matrix Q from an optimized TMB or RTMB obj. — .get_Q","title":"Get the joint precision matrix Q from an optimized TMB or RTMB obj. — .get_Q","text":"Get joint precision matrix Q optimized TMB RTMB obj.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_Q.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Get the joint precision matrix Q from an optimized TMB or RTMB obj. — .get_Q","text":"","code":".get_Q(obj)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_Q.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Get the joint precision matrix Q from an optimized TMB or RTMB obj. — .get_Q","text":"obj optimized TMB RTMB object","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_Q.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Get the joint precision matrix Q from an optimized TMB or RTMB obj. — .get_Q","text":"sparse matrix Q","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_Qinv.html","id":null,"dir":"Reference","previous_headings":"","what":"Get the joint covariance Sigma from an optimized TMB or RTMB obj without random effects. — .get_Qinv","title":"Get the joint covariance Sigma from an optimized TMB or RTMB obj without random effects. — .get_Qinv","text":"Get joint covariance Sigma optimized TMB RTMB obj without random effects.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_Qinv.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Get the joint covariance Sigma from an optimized TMB or RTMB obj without random effects. — .get_Qinv","text":"","code":".get_Qinv(obj)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_Qinv.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Get the joint covariance Sigma from an optimized TMB or RTMB obj without random effects. — .get_Qinv","text":"obj optimized TMB RTMB object","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_Qinv.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Get the joint covariance Sigma from an optimized TMB or RTMB obj without random effects. — .get_Qinv","text":"dense matrix Sigma","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_inits.html","id":null,"dir":"Reference","previous_headings":"","what":"Get a single initial value vector in untransformed model space — .get_inits","title":"Get a single initial value vector in untransformed model space — .get_inits","text":"Get single initial value vector untransformed model space","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_inits.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Get a single initial value vector in untransformed model space — .get_inits","text":"","code":".get_inits(init, obj2, seed, inputs)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_inits.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Get a single initial value vector in untransformed model space — .get_inits","text":"init initial value strategy obj2 joint TMB model seed RNG seed inputs list returned .get_inputs.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_inputs.html","id":null,"dir":"Reference","previous_headings":"","what":"Prepare inputs for sparse sampling — .get_inputs","title":"Prepare inputs for sparse sampling — .get_inputs","text":"@param obj Object @param skip_optimization Whether skip @param laplace Whether due LA @param metric metric @param Q Sparse precision @param Qinv Inverse Q @return list containing Q, Qinv, mle list, timings","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-get_inputs.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Prepare inputs for sparse sampling — .get_inputs","text":"","code":".get_inputs(obj, skip_optimization, laplace, metric, Q, Qinv)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-make_unique_names.html","id":null,"dir":"Reference","previous_headings":"","what":"Function to take a character vector of parameter names and force them to be unique by appending numbers in square brackets as needed — .make_unique_names","title":"Function to take a character vector of parameter names and force them to be unique by appending numbers in square brackets as needed — .make_unique_names","text":"Function take character vector parameter names force unique appending numbers square brackets needed","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-make_unique_names.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Function to take a character vector of parameter names and force them to be unique by appending numbers in square brackets as needed — .make_unique_names","text":"","code":".make_unique_names(x)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-make_unique_names.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Function to take a character vector of parameter names and force them to be unique by appending numbers in square brackets as needed — .make_unique_names","text":"x Character vector","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-print.mat.stats.html","id":null,"dir":"Reference","previous_headings":"","what":"Print matrix stats — .print.mat.stats","title":"Print matrix stats — .print.mat.stats","text":"Print matrix stats","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-print.mat.stats.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Print matrix stats — .print.mat.stats","text":"","code":".print.mat.stats(x)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-print.mat.stats.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Print matrix stats — .print.mat.stats","text":"x matrix object","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-rotate_posterior.html","id":null,"dir":"Reference","previous_headings":"","what":"Update algorithm for mass matrix. — .rotate_posterior","title":"Update algorithm for mass matrix. — .rotate_posterior","text":"Update algorithm mass matrix.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-rotate_posterior.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Update algorithm for mass matrix. — .rotate_posterior","text":"","code":".rotate_posterior(metric, fn, gr, Q, Qinv, y.cur)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-rotate_posterior.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Update algorithm for mass matrix. — .rotate_posterior","text":"metric metric use fn current fn function. gr current gr function Q sparse precision matrix Qinv inverse Q y.cur current parameter vector unrotated (Y) space.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-rotate_space.html","id":null,"dir":"Reference","previous_headings":"","what":"Update algorithm for mass matrix. — .rotate_space","title":"Update algorithm for mass matrix. — .rotate_space","text":"Update algorithm mass matrix.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-rotate_space.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Update algorithm for mass matrix. — .rotate_space","text":"","code":".rotate_space(fn, gr, M, y.cur)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/dot-rotate_space.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Update algorithm for mass matrix. — .rotate_space","text":"fn current fn function. gr current gr function M new mass matrix y.cur current parameter vector unrotated (Y) space.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_sampler_params.html","id":null,"dir":"Reference","previous_headings":"","what":"Extract sampler parameters from a fit. — extract_sampler_params","title":"Extract sampler parameters from a fit. — extract_sampler_params","text":"Extract information NUTS trajectories, acceptance ratio treedepth, fitted object.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_sampler_params.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Extract sampler parameters from a fit. — extract_sampler_params","text":"","code":"extract_sampler_params(fit, inc_warmup = FALSE)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_sampler_params.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Extract sampler parameters from a fit. — extract_sampler_params","text":"fit list returned sample_admb. inc_warmup Whether extract warmup samples (default). Warmup samples never used inference, may useful diagnostics.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_sampler_params.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Extract sampler parameters from a fit. — extract_sampler_params","text":"invisible data.frame containing samples (rows) parameter (columns). multiple chains exist rbinded together.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_sampler_params.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Extract sampler parameters from a fit. — extract_sampler_params","text":"trajectory (iteration) NUTS associated information trajectory: stepsize, acceptance ratio, treedepth, number leapfrog steps. function extracts data.frame, may useful diagnosing issues certain cases. general, user need examine , preferably via plot_sampler_params  launch_shinyadmb.","code":""},{"path":[]},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_sampler_params.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Extract sampler parameters from a fit. — extract_sampler_params","text":"","code":"fit <- readRDS(system.file('examples', 'fit.RDS', package='SparseNUTS')) #> Warning: cannot open compressed file '', probable reason 'No such file or directory' #> Error in gzfile(file, \"rb\"): cannot open the connection sp <- extract_sampler_params(fit, inc_warmup=TRUE) #> Error: object 'fit' not found str(sp) #> Error: object 'sp' not found"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_samples.html","id":null,"dir":"Reference","previous_headings":"","what":"Extract posterior samples from a model fit. — extract_samples","title":"Extract posterior samples from a model fit. — extract_samples","text":"helper function extract posterior samples across multiple chains single data.frame.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_samples.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Extract posterior samples from a model fit. — extract_samples","text":"","code":"extract_samples(   fit,   inc_warmup = FALSE,   inc_lp = FALSE,   as.list = FALSE,   unbounded = FALSE )"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_samples.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Extract posterior samples from a model fit. — extract_samples","text":"fit list returned sample_admb. inc_warmup Whether extract warmup samples (default). Warmup samples never used inference, may useful diagnostics. inc_lp Whether include column log posterior density (last column). diagnostics can useful. .list Whether return samples list (one element per chain). converted CODA mcmc object. unbounded Boolean flag whether return samples unbounded (untransformed) space. differences init_bounded types used ADMB template. can useful model debugging.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_samples.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Extract posterior samples from a model fit. — extract_samples","text":".list FALSE, invisible data.frame containing samples (rows) parameter (columns). multiple chains exist rbinded together, maintaining order within chain. .list TRUE, samples returned list matrices.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_samples.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Extract posterior samples from a model fit. — extract_samples","text":"function loosely based rstan function extract. Merging samples across chains used inference appropriate diagnostic checks. calculate diagnostics like Rhat effective sample size using function, instead, use monitor. Likewise, warmup samples valid never used inference, may useful cases diagnosing issues.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/extract_samples.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Extract posterior samples from a model fit. — extract_samples","text":"","code":"## A previously run fitted ADMB model fit <- readRDS(system.file('examples', 'fit.RDS', package='SparseNUTS')) #> Warning: cannot open compressed file '', probable reason 'No such file or directory' #> Error in gzfile(file, \"rb\"): cannot open the connection post <- extract_samples(fit) #> Error: object 'fit' not found tail(apply(post, 2, median)) #> Error: object 'post' not found"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/get_post.html","id":null,"dir":"Reference","previous_headings":"","what":"Extract posterior samples from a tmbfit object — get_post","title":"Extract posterior samples from a tmbfit object — get_post","text":"Extract posterior samples tmbfit object","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/get_post.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Extract posterior samples from a tmbfit object — get_post","text":"","code":"get_post(x, invf, parnames, array = FALSE)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/get_post.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Extract posterior samples from a tmbfit object — get_post","text":"x fitted tmbfit object invf inverse function decorrelate parameters parnames vector parameter names, excluding lp__ array Whether return data.frame (default) array used constructing objects downstream","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/is.snutsfit.html","id":null,"dir":"Reference","previous_headings":"","what":"Check object of class snutsfit — is.snutsfit","title":"Check object of class snutsfit — is.snutsfit","text":"Check object class snutsfit","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/is.snutsfit.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Check object of class snutsfit — is.snutsfit","text":"","code":"is.snutsfit(x)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/is.snutsfit.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Check object of class snutsfit — is.snutsfit","text":"x Returned list sample_admb","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/launch_shinytmb.html","id":null,"dir":"Reference","previous_headings":"","what":"Launch shinystan for a TMB fit. — launch_shinytmb","title":"Launch shinystan for a TMB fit. — launch_shinytmb","text":"Launch shinystan TMB fit.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/launch_shinytmb.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Launch shinystan for a TMB fit. — launch_shinytmb","text":"","code":"launch_shinytmb(fit)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/launch_shinytmb.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Launch shinystan for a TMB fit. — launch_shinytmb","text":"fit named list returned sample_tmb.","code":""},{"path":[]},{"path":[]},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/pairs.snutsfit.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot pairwise parameter posteriors and optionally the MLE points and confidence ellipses. — pairs.snutsfit","text":"","code":"# S3 method for class 'snutsfit' pairs(   x,   pars = NULL,   order = c(\"orig\", \"slow\", \"fast\", \"mismatch\", \"cor\"),   inc_warmup = FALSE,   diag = c(\"trace\", \"acf\", \"hist\"),   acf.ylim = c(-1, 1),   ymult = NULL,   axis.col = gray(0.5),   label.cex = 0.8,   limits = NULL,   add.mle = TRUE,   add.monitor = TRUE,   add.inits = FALSE,   unbounded = FALSE,   ... )"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/pairs.snutsfit.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot pairwise parameter posteriors and optionally the MLE points and confidence ellipses. — pairs.snutsfit","text":"pars character vector parameters integers representing parameters subset. Useful model larger number parameters just want show key ones. order order consider parameters. Options 'orig' (default) use order declared model, 'slow' 'fast' based effective sample sizes ordered slowest fastest mixing respectively. 'mismatch' sorts parameters large discrepancies MLE posterior marginal variances, defined absolute relative difference MLE posterior .e., abs((mle-post)/post). Finally, 'cor' orders largest maximum absolute pairwise posterior correlation (including lp__). See example usage. inc_warmup Whether include warmup samples (default). diag type plot include diagonal, options 'acf' plots autocorrelation function acf, 'hist' shows marginal posterior histograms, 'trace' trace plot. acf.ylim using acf function diagonal, specify y limit. default c(-1,1). ymult vector length ncol(posterior) specifying much room give using hist option diagonal. use label blocking part plot. default 1.3 parameters. axis.col Color axes label.cex Control size outer diagonal labels (default 1) limits list containing ranges parameter use plotting. add.mle Boolean whether add 95\\ add.monitorBoolean whether print effective sample add.initsBoolean whether add initial values plot unboundedWhether use bounded unbounded version parameters.  size (ESS) Rhat values diagonal. ...Arguments passed plot call lower triangular panels (scatterplots). fitA list returned sample_nuts. Produces plot, returns nothing.   Plot pairwise parameter posteriors optionally MLE points confidence ellipses.   function modified base pairs code work specifically fits 'adnuts' package using either NUTS RWM MCMC algorithms. invertible Hessian found (fit$mle) estimated covariances available compare added automatically (red ellipses). Likewise, \"monitor\" object rstan::monitor attached fit$monitor provides effective sample sizes (ESS) Rhat values. ESS used potentially order parameters via argument order, also printed diagonal.   fit <- readRDS(system.file('examples', 'fit.RDS', package='adnuts')) pairs(fit) pairs(fit, pars=1:2) pairs(fit, pars=c(2,1)) pairs(fit, pars=c('b', '')) pairs(fit, pars=1:2, order='slow') pairs(fit, pars=1:2, order='fast') pairs(fit, pars=1:2, order='mismatch')  Cole Monnahan","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot.snutsfit.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot object of class snutsfit — plot.snutsfit","title":"Plot object of class snutsfit — plot.snutsfit","text":"Plot object class snutsfit","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot.snutsfit.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot object of class snutsfit — plot.snutsfit","text":"","code":"# S3 method for class 'snutsfit' plot(x, y, ...)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot.snutsfit.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot object of class snutsfit — plot.snutsfit","text":"x Fitted object sample_admb y Ignored ... Ignored","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot.snutsfit.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot object of class snutsfit — plot.snutsfit","text":"Plot created","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_Q.html","id":null,"dir":"Reference","previous_headings":"","what":"Make an image plot showing the correlation (lower triangle) and sparsity (upper triangle). — plot_Q","title":"Make an image plot showing the correlation (lower triangle) and sparsity (upper triangle). — plot_Q","text":"Make image plot showing correlation (lower triangle) sparsity (upper triangle).","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_Q.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Make an image plot showing the correlation (lower triangle) and sparsity (upper triangle). — plot_Q","text":"","code":"plot_Q(fit, Q = NULL)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_Q.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Make an image plot showing the correlation (lower triangle) and sparsity (upper triangle). — plot_Q","text":"fit fitted object Q sparse matrix. NULL extracted fit.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_Q.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Make an image plot showing the correlation (lower triangle) and sparsity (upper triangle). — plot_Q","text":"plot created Matrix::image.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_Q.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Make an image plot showing the correlation (lower triangle) and sparsity (upper triangle). — plot_Q","text":"function used visualize sparsity correlation patterns joint model. upper triangle shows whether element 0 (white) (gray), lower triangle shows correlation calculated cov2cor(solve(Q)).","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_marginals.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot marginal distributions for a fitted model — plot_marginals","title":"Plot marginal distributions for a fitted model — plot_marginals","text":"Plot marginal distributions fitted model","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_marginals.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot marginal distributions for a fitted model — plot_marginals","text":"","code":"plot_marginals(   fit,   pars = NULL,   mfrow = NULL,   add.mle = TRUE,   add.monitor = TRUE,   breaks = 30 )"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_marginals.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot marginal distributions for a fitted model — plot_marginals","text":"fit fitted object returned sample_admb. pars numeric character vector parameters plot, plotting subset total (defaults ) mfrow custom grid size (vector two) called par(mfrow), overriding defaults. add.mle Whether add marginal normal distributions determined inverse Hessian file add.monitor Whether add ESS Rhat information breaks number breaks use hist(), defaulting 30","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_marginals.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Plot marginal distributions for a fitted model — plot_marginals","text":"function plots grid cells parameters model, comparing marginal posterior histogram vs asymptotic normal (red lines) inverse Hessian. intended use quickly gauge differences frequentist Bayesian inference model. fit$monitor exists effective sample size (ESS) R-hat estimates printed top right corner. See https://mc-stan.org/rstan/reference/Rhat.html information. Generally Rhat>1.05 ESS<100 (per chain) suggest inference may unreliable. function customized work multipage PDFs, specifically: pdf('marginals.pdf', onefile=TRUE, width=7,height=5) produces nice readable file.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_marginals.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot marginal distributions for a fitted model — plot_marginals","text":"","code":"fit <- readRDS(system.file('examples', 'fit.RDS', package='SparseNUTS')) #> Warning: cannot open compressed file '', probable reason 'No such file or directory' #> Error in gzfile(file, \"rb\"): cannot open the connection plot_marginals(fit, pars=1:2) #> Error: object 'fit' not found"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_sampler_params.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot adaptation metrics for a fitted model. — plot_sampler_params","title":"Plot adaptation metrics for a fitted model. — plot_sampler_params","text":"Plot adaptation metrics fitted model.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_sampler_params.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot adaptation metrics for a fitted model. — plot_sampler_params","text":"","code":"plot_sampler_params(fit, plot = TRUE)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_sampler_params.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot adaptation metrics for a fitted model. — plot_sampler_params","text":"fit fitted object returned sample_admb. plot Whether plot results","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_sampler_params.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot adaptation metrics for a fitted model. — plot_sampler_params","text":"Prints invisibly returns ggplot object","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_sampler_params.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Plot adaptation metrics for a fitted model. — plot_sampler_params","text":"utility function quickly plots adaptation output NUTS chains.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_sampler_params.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot adaptation metrics for a fitted model. — plot_sampler_params","text":"","code":"fit <- readRDS(system.file('examples', 'fit.RDS', package='SparseNUTS')) #> Warning: cannot open compressed file '', probable reason 'No such file or directory' #> Error in gzfile(file, \"rb\"): cannot open the connection plot_sampler_params(fit) #> Error: object 'fit' not found"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_uncertainties.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot MLE vs MCMC marginal standard deviations for each parameter — plot_uncertainties","title":"Plot MLE vs MCMC marginal standard deviations for each parameter — plot_uncertainties","text":"Plot MLE vs MCMC marginal standard deviations parameter","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_uncertainties.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot MLE vs MCMC marginal standard deviations for each parameter — plot_uncertainties","text":"","code":"plot_uncertainties(fit, log = TRUE, plot = TRUE)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_uncertainties.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot MLE vs MCMC marginal standard deviations for each parameter — plot_uncertainties","text":"fit fitted object returned sample_admb log Whether plot axes log space (default TRUE). plot Whether plot .","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_uncertainties.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot MLE vs MCMC marginal standard deviations for each parameter — plot_uncertainties","text":"Invisibly returns data.frame parameter name (row) estimated uncertainties method (columns).","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_uncertainties.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Plot MLE vs MCMC marginal standard deviations for each parameter — plot_uncertainties","text":"can helpful compare uncertainty estimates two paradigms. plots marginal posterior standard deviation vs frequentist standard error estimated .cor file. Large differences often indicate issues one estimation method.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/plot_uncertainties.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot MLE vs MCMC marginal standard deviations for each parameter — plot_uncertainties","text":"","code":"fit <- readRDS(system.file('examples', 'fit.RDS', package='SparseNUTS')) #> Warning: cannot open compressed file '', probable reason 'No such file or directory' #> Error in gzfile(file, \"rb\"): cannot open the connection x <- plot_uncertainties(fit, plot=FALSE) #> Error: object 'fit' not found head(x) #> Error: object 'x' not found"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/print.snutsfit.html","id":null,"dir":"Reference","previous_headings":"","what":"Print summary of snutsfit object — print.snutsfit","title":"Print summary of snutsfit object — print.snutsfit","text":"Print summary snutsfit object","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/print.snutsfit.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Print summary of snutsfit object — print.snutsfit","text":"","code":"# S3 method for class 'snutsfit' print(x, ...)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/print.snutsfit.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Print summary of snutsfit object — print.snutsfit","text":"x Fitted object sample_admb ... Ignored","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/print.snutsfit.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Print summary of snutsfit object — print.snutsfit","text":"Summary printed console","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_inits.html","id":null,"dir":"Reference","previous_headings":"","what":"Function to generate random initial values from a previous fit using SparseNUTS — sample_inits","title":"Function to generate random initial values from a previous fit using SparseNUTS — sample_inits","text":"Function generate random initial values previous fit using SparseNUTS","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_inits.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Function to generate random initial values from a previous fit using SparseNUTS — sample_inits","text":"","code":"sample_inits(fit, chains)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_inits.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Function to generate random initial values from a previous fit using SparseNUTS — sample_inits","text":"fit outputted list sample_admb chains number chains subsequent run, determines number return.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_inits.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Function to generate random initial values from a previous fit using SparseNUTS — sample_inits","text":"list lists can passed back sample_admb.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_snuts.html","id":null,"dir":"Reference","previous_headings":"","what":"NUTS sampling for TMB models using a sparse metric (BETA). — sample_snuts","title":"NUTS sampling for TMB models using a sparse metric (BETA). — sample_snuts","text":"NUTS sampling TMB models using sparse metric (BETA).","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_snuts.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"NUTS sampling for TMB models using a sparse metric (BETA). — sample_snuts","text":"","code":"sample_snuts(   obj,   num_samples = 1000,   num_warmup = NULL,   chains = 4,   cores = chains,   thin = 1,   adapt_stan_metric = NULL,   control = NULL,   seed = NULL,   laplace = FALSE,   init = c(\"last.par.best\", \"random\", \"random-t\", \"unif\"),   metric = c(\"auto\", \"unit\", \"diag\", \"dense\", \"sparse\", \"stan\", \"sparse-naive\"),   skip_optimization = FALSE,   Q = NULL,   Qinv = NULL,   globals = NULL,   model_name = NULL,   refresh = NULL,   print = TRUE,   rotation_only = FALSE,   lower = NULL,   upper = NULL,   iter = 2000,   warmup = floor(iter/2),   ... )"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_snuts.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"NUTS sampling for TMB models using a sparse metric (BETA). — sample_snuts","text":"obj TMB object random effects turned optimized. num_samples number post-warmup iterations run per chain. num_warmup number warmup iterations run per chain. default NULL indicates automatically determine based settings (recommended). chains Number chains cores Number parallel cores use, defaults chains set 1 execute serial chains. thin thinning rate (defaults 1). adapt_stan_metric boolean whether Stan engage diagonal mass matrix adaptation. default NULL indicates automatically select depending settings. See details. control NUTS control list, currently available options 'adapt_delta', 'max_treedepth', 'metric' type metric adaptation Stan options ('unit_e', 'diag_e', 'dense_e'). dense sparse metrics usually can 'unit_e' skip adaptation. NULL values (default) revert stan_sample defaults. seed Random number seed, used generating initial values ('random\") NUTS. laplace Whether leave Laplace approximation use NUTS sample fixed effects, turn sample joint parameter space (default). init Either 'last.par.best' (default), 'random', 'random-t', 'unif'. former starts joint mode, 'random' 'random-t' draw multivariate normal multivariate t 2 degrees freedom distributions using inverse joint precision matrix covariance matrix. 'random-t' provided allow dispersed initial values. 'unif' draw U(-2,2) samples parameters, similar ot Stan's default behavior. joint NLL undefined initial values model exit return initial vector investigation user, desired. Note stan_sample allows init vector chains currently. seed specified set thus inits used reproducible. inits also returned 'inits' slot fitted object. metric character specifying metric use. Defaults \"auto\" uses algorithm select best metric (see details), otherwise one \"sparse\", \"dense\", \"diag\", \"unit\", \"Stan\", \"sparse-naive\" can specified. skip_optimization Whether skip optimization (default). model already optimized Q available redundant steps can skipped. Q sparse precision matrix. calculated internally specified (default). Qinv dense matrix \\(Q^{-1}\\). calculated internally specified (default). globals named list objects pass new R sessions running parallel using RTMB. Typically data object now. model_name optional character giving model name. NULL use DLL name RTMB models just 'RTMB'. name used printing. refresh often print updates console (integer). 0 turn printing. default 100. print Whether print summary run (default) rotation_only Whether return rotation object (debugging purposes) lower, upper vector lower upper bounds. valid 'stan' 'unit' metrics. See details. Can finite infinite. iter (Deprecated) Total iterations run (warmup + sampling) warmup (Deprecated) Total warmup iterations. Defaults iter/2 based Stan defaults, using dense, sparse, diag metrics much shorter warmup can used (e.g., 150), especially paired 'unit_e' Stan metric. Use plot_sampler_params investigate warmup performance adjust necessary subsequent runs. ... Additional arguments pass StanEstimators::stan_sample.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_snuts.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"NUTS sampling for TMB models using a sparse metric (BETA). — sample_snuts","text":"fitted MCMC object class 'snutsfit'","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_snuts.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"NUTS sampling for TMB models using a sparse metric (BETA). — sample_snuts","text":"TMB metric used decorrelate descale posterior distribution sampling Stan's algorithms. chosen metric reasoning selection printed console sampling begins. Metric Options 'auto': default setting. uses internal algorithm determine optimal metric model. choice depends availability precision matrix (\\(Q\\)) /covariance matrix (\\(M=Q^{-1}\\)), extent parameter correlations, speed gradient calculations. 'dense' 'sparse': options decorrelate descale posterior. However, 'sparse' metric computationally efficient models high-dimensional, sparse precision matrices. models without random effects 'sparse' option available 'diag': option descales posterior, using marginal standard deviations derived covariance matrix \\(M\\). account correlations. 'unit': option uses identity matrix, default behavior Stan. Unlike 'Stan' option , model still optimized find mode, \\(Q\\) matrix calculated. ensures full mle object (containing mode, standard errors, correlations) returned. 'sparse-naive': metric constructed mathematically equivalent 'dense' often computationally faster. generally recommended testing exploration. 'stan': special flag reverts sampler standard Stan behavior. skips optimization \\(Q\\) matrix calculations ensures Stan's mass matrix adaptation engaged warmup. Important Distinction Note metric parameter described specific TMB distinct Stan metric, controlled via control list argument sampling function. Stan default adapts diagonal mass matrix (metric_e) using series expanding windows. \\(Q\\) good estimate global precision needed disabling Stan's metric adaptation recommended. can done setting adapt_stan_metric=FALSE. left NULL Stan's adaptation done metrics 'stan' 'unit' two options descale posterior. case, recommended use longer warmup period account adaptive procedure. Parameter bounds can passed via lower upper vector arguments. can finite infinite, length equal number parameters depend whether laplace TRUE . However, bounds used metric decorrelates descales posterior bounds applied operation make sense. 'stan' 'unit' metrics can used. However, general currently recommended parameter transformations directly model add Jacobian adjustment necessary.","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_sparse_tmb.html","id":null,"dir":"Reference","previous_headings":"","what":"Deprecated version of sample_snuts — sample_sparse_tmb","title":"Deprecated version of sample_snuts — sample_sparse_tmb","text":"Deprecated version sample_snuts","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/sample_sparse_tmb.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Deprecated version of sample_snuts — sample_sparse_tmb","text":"","code":"sample_sparse_tmb(...)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/snutsfit.html","id":null,"dir":"Reference","previous_headings":"","what":"Constructor for the ","title":"Constructor for the ","text":"Constructor \"snutsfit\" (-D fit) class","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/snutsfit.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Constructor for the ","text":"","code":"snutsfit(x)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/snutsfit.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Constructor for the ","text":"x Fitted object sample_admb","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/snutsfit.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Constructor for the ","text":"object class \"snutsfit\"","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/summary.snutsfit.html","id":null,"dir":"Reference","previous_headings":"","what":"Print summary of object of class snutsfit — summary.snutsfit","title":"Print summary of object of class snutsfit — summary.snutsfit","text":"Print summary object class snutsfit","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/summary.snutsfit.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Print summary of object of class snutsfit — summary.snutsfit","text":"","code":"# S3 method for class 'snutsfit' summary(object, ...)"},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/summary.snutsfit.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Print summary of object of class snutsfit — summary.snutsfit","text":"object Fitted object sample_admb ... Ignored","code":""},{"path":"https://cole-monnahan-noaa.github.io/SparseNUTS/reference/summary.snutsfit.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Print summary of object of class snutsfit — summary.snutsfit","text":"Summary printed screen","code":""}]
